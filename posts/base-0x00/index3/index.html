<!DOCTYPE html>
<html lang="br">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Base 0x00 - Procedimento de linking &amp; seus tipos :: Midnight Hackings</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" Escrito por: Mateus Gualberto (Midnight Reverser) - orgulho de escrever sem IA envolvida no processo!
Licen√ßa: livre, como todo conhecimento deve ser.
Introdu√ß√£o Softwares s√£o compostos, em sua maioria, por c√≥digos pr√≥prios, escritos pelo programador daquele software, e por c√≥digos de bibliotecas, feito por outros programadores. Bibliotecas podem ser entendidas como c√≥digos j√° escritos, reus√°veis, que fornecem implementa√ß√µes de fun√ß√µes a serem utilizadas por diversos outros programas. Por exemplo, uma biblioteca de matem√°tica fornece fun√ß√µes que podem ser utilizadas por um programa simples de somar dois n√∫meros, um software de calculadora ou at√© mesmo programas para auxiliar estudos cient√≠ficos em √°reas que dependem de precis√£o de v√°rias casas decimais.
" />
<meta name="keywords" content="midnight,blog,reverse-engineer,reversing" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/base-0x00/index3/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="http://localhost:1313/terminal.css">




<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="br" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Base 0x00 - Procedimento de linking &amp; seus tipos">
<meta property="og:description" content=" Escrito por: Mateus Gualberto (Midnight Reverser) - orgulho de escrever sem IA envolvida no processo!
Licen√ßa: livre, como todo conhecimento deve ser.
Introdu√ß√£o Softwares s√£o compostos, em sua maioria, por c√≥digos pr√≥prios, escritos pelo programador daquele software, e por c√≥digos de bibliotecas, feito por outros programadores. Bibliotecas podem ser entendidas como c√≥digos j√° escritos, reus√°veis, que fornecem implementa√ß√µes de fun√ß√µes a serem utilizadas por diversos outros programas. Por exemplo, uma biblioteca de matem√°tica fornece fun√ß√µes que podem ser utilizadas por um programa simples de somar dois n√∫meros, um software de calculadora ou at√© mesmo programas para auxiliar estudos cient√≠ficos em √°reas que dependem de precis√£o de v√°rias casas decimais.
" />
<meta property="og:url" content="http://localhost:1313/posts/base-0x00/index3/" />
<meta property="og:site_name" content="Midnight Hackings" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2024-03-22 21:00:00 -0300 -03" />












</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Midnight Hackings
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;‚ñæ</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/posts">Postagens</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
        
          <li><a href="https://github.com/midnight-rev">Github</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
        
          <li><a href="/contact">Sobre</a></li>
        
      
      
        <hr />
        
          <li>
            <a href="http://localhost:1313/">üáßüá∑ Brasileiro</a>
          </li>
        
      
    </ul>
  </li>
</ul>

    
    
      <ul class="menu menu--desktop menu--language-selector">
  <li class="menu__trigger">üáßüá∑ Brasileiro&nbsp;‚ñæ</li>
  <li>
    <ul class="menu__dropdown">
      
        <li><a href="http://localhost:1313/">üáßüá∑ Brasileiro</a></li>
      
    </ul>
  </li>
</ul>

    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/posts" >Postagens</a></li>
        
      
        
          <li><a href="/tags" >Tags</a></li>
        
      
        
          <li><a href="https://github.com/midnight-rev" >Github</a></li>
        
      
        
          <li><a href="/index.xml" >RSS</a></li>
        
      
        
          <li><a href="/contact" >Sobre</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/base-0x00/index3/">Base 0x00 - Procedimento de linking &amp; seus tipos</a>
  </h1>
  <div class="post-meta"><time class="post-date">22/03/2024&nbsp;[Atualizado em 22/03/2024]</time><span class="post-reading-time">15 minuto(s) de leitura (3109 palavras)</span></div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/programming/">programming</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/base-knowledge/">base-knowledge</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/linking/">linking</a>&nbsp;
      
    </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Sum√°rio
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#execut√°veis">Execut√°veis</a></li>
    <li><a href="#tipos-de-linking">Tipos de linking</a>
      <ul>
        <li><a href="#static-linking">Static Linking</a></li>
        <li><a href="#dynamic-linking-load-time-dynamic-linking">Dynamic Linking (load-time Dynamic Linking)</a></li>
        <li><a href="#runtime-linking-run-time-dynamic-linking">Runtime Linking (run-time Dynamic Linking)</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <blockquote>
<p>Escrito por: Mateus Gualberto (Midnight Reverser) - <strong>orgulho de escrever sem IA envolvida no processo!</strong><br>
Licen√ßa: livre, como todo conhecimento deve ser.</p>
</blockquote>
<h1 id="introdu√ß√£o">Introdu√ß√£o<a href="#introdu√ß√£o" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>Softwares s√£o compostos, em sua maioria, por c√≥digos pr√≥prios, escritos pelo programador daquele software, e por c√≥digos de bibliotecas, feito por outros programadores. Bibliotecas podem ser entendidas como c√≥digos j√° escritos, reus√°veis, que fornecem implementa√ß√µes de fun√ß√µes a serem utilizadas por diversos outros programas. Por exemplo, uma biblioteca de matem√°tica fornece fun√ß√µes que podem ser utilizadas por um programa simples de somar dois n√∫meros, um software de calculadora ou at√© mesmo programas para auxiliar estudos cient√≠ficos em √°reas que dependem de precis√£o de v√°rias casas decimais.</p>
<p>Nesse artigo, iremos entender os tipos de bibliotecas existentes e  como elas s√£o incorporadas pelos programas que as utilizam. Vamos analisar a forma como os arquivos execut√°veis, em especial os <em>Portable Executable</em> (EXE) e <em>Executable and Linikable Format</em>, mant√©m refer√™ncia √†s fun√ß√µes importadas de bibliotecas e explicar/implementar t√©cnicas utilizadas por malwares para evadir detec√ß√£o e a fase de an√°lise est√°tica simples realizada por analistas de malware.</p>
<h2 id="execut√°veis">Execut√°veis<a href="#execut√°veis" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>A gera√ß√£o de um execut√°vel passa pelos est√°gios de escrita de um c√≥digo (geralmente em uma linguagem de alto n√≠vel port√°vel, como C/C++) e a fase conhecida genericamente por &ldquo;compila√ß√£o&rdquo;. Por√©m, a &ldquo;compila√ß√£o&rdquo;, como √© popularmente conhecida, consiste de diversas etapas, dentre elas a pr√≥pria compila√ß√£o - transforma√ß√£o de um c√≥digo em alto n√≠vel em um source Assembly - montagem e linking. Na imagem abaixo est√£o representadas as fases gen√©ricas da compila√ß√£o de um arquivo.</p>
<img alt="03762422f33b940c9ab2650e38caa65c.png" src="img/03762422f33b940c9ab2650e38caa65c.png"><p>O primeiro passo √© a compila√ß√£o de um ou mais arquivos de c√≥digo-fonte de uma linguagem de programa√ß√£o de alto n√≠vel para um fonte em assembly, representado pelo passo <em>Compilation (gcc -S)</em> na figura. Tomemos como exemplo o seguinte c√≥digo <em>hello.c</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Hello World</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Ao executarmos <code>gcc -S hello.c</code>, obtemos a seguinte sa√≠da no arquivo gerado <em>hello.s</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">        <span class="na">.file</span>   <span class="s">&#34;hello.c&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">.text</span>
</span></span><span class="line"><span class="cl">        <span class="na">.section</span>        <span class="no">.rodata</span>
</span></span><span class="line"><span class="cl"><span class="nl">.LC0:</span>
</span></span><span class="line"><span class="cl">        <span class="na">.string</span> <span class="s">&#34;Hello World&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">.text</span>
</span></span><span class="line"><span class="cl">        <span class="na">.globl</span>  <span class="no">main</span>
</span></span><span class="line"><span class="cl">        <span class="na">.type</span>   <span class="no">main</span><span class="p">,</span> <span class="na">@function</span>
</span></span><span class="line"><span class="cl"><span class="nl">main:</span>
</span></span><span class="line"><span class="cl"><span class="nl">.LFB0:</span>
</span></span><span class="line"><span class="cl">        <span class="na">.cfi_startproc</span>
</span></span><span class="line"><span class="cl">        <span class="nf">endbr64</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pushq</span>   <span class="nv">%rbp</span>
</span></span><span class="line"><span class="cl">        <span class="na">.cfi_def_cfa_offset</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="na">.cfi_offset</span> <span class="mi">6</span><span class="p">,</span> <span class="p">-</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="nf">movq</span>    <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
</span></span><span class="line"><span class="cl">        <span class="na">.cfi_def_cfa_register</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">        <span class="nf">leaq</span>    <span class="no">.LC0</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rax</span>
</span></span><span class="line"><span class="cl">        <span class="nf">movq</span>    <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
</span></span><span class="line"><span class="cl">        <span class="nf">call</span>    <span class="no">puts@PLT</span>
</span></span><span class="line"><span class="cl">        <span class="nf">movl</span>    <span class="no">$0</span><span class="p">,</span> <span class="nv">%eax</span>
</span></span><span class="line"><span class="cl">        <span class="nf">popq</span>    <span class="nv">%rbp</span>
</span></span><span class="line"><span class="cl">        <span class="na">.cfi_def_cfa</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ret</span>
</span></span><span class="line"><span class="cl">        <span class="na">.cfi_endproc</span>
</span></span><span class="line"><span class="cl"><span class="nl">.LFE0:</span>
</span></span><span class="line"><span class="cl">        <span class="na">.size</span>   <span class="no">main</span><span class="p">,</span> <span class="no">.-main</span>
</span></span><span class="line"><span class="cl">        <span class="na">.ident</span>  <span class="s">&#34;GCC: (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">.section</span>        <span class="no">.note.GNU-stack</span><span class="p">,</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="na">@progbits</span>
</span></span><span class="line"><span class="cl">        <span class="na">.section</span>        <span class="no">.note.gnu.property</span><span class="p">,</span><span class="s">&#34;a&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="na">.align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="na">.long</span>   <span class="mi">1</span><span class="no">f</span> <span class="p">-</span> <span class="mi">0</span><span class="no">f</span>
</span></span><span class="line"><span class="cl">        <span class="na">.long</span>   <span class="mi">4</span><span class="no">f</span> <span class="p">-</span> <span class="mi">1</span><span class="no">f</span>
</span></span><span class="line"><span class="cl">        <span class="na">.long</span>   <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="err">0:</span>
</span></span><span class="line"><span class="cl">        <span class="na">.string</span> <span class="s">&#34;GNU&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">1:</span>
</span></span><span class="line"><span class="cl">        <span class="na">.align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="na">.long</span>   <span class="mi">0xc0000002</span>
</span></span><span class="line"><span class="cl">        <span class="na">.long</span>   <span class="mi">3</span><span class="no">f</span> <span class="p">-</span> <span class="mi">2</span><span class="no">f</span>
</span></span><span class="line"><span class="cl"><span class="err">2:</span>
</span></span><span class="line"><span class="cl">        <span class="na">.long</span>   <span class="mi">0x3</span>
</span></span><span class="line"><span class="cl"><span class="err">3:</span>
</span></span><span class="line"><span class="cl">        <span class="na">.align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="err">4:</span>
</span></span></code></pre></div><p>Esse arquivo n√£o √© trivial e utiliza muitas muitas diretivas do <a href="https://ftp.gnu.org/old-gnu/Manuals/gas-2.9.1/html_node/as_3.html">GNU Assembler</a>, que n√£o s√£o necessariamente instru√ß√µes. A main √© indicada pela label <em>main</em> e em espec√≠fico pela label local <em>.LFB0</em>. A string <em>Hello, World</em> √© indicada pela label local <em>.LC0</em>, que √© utilizada diretamente em <em>.LFB0</em>.</p>
<p>O arquivo descrito acima √© processado internamente pela suite <em>gcc</em> para gerar o <em>arquivo-objeto</em>, algo que tamb√©m pode ser realizado pelo GNU Assembler via <code>as hello.s -o hello.o</code>, conforme imagem abaixo. Ao analisar os metadados de <code>hello.o</code> com os softwares <em>file</em> e <em>readelf</em>, √© poss√≠vel perceber que um arquivo-objeto em Linux nada mais √© que um arquivo ELF reloc√°vel (mais especificamente o tipo <strong>ET_REL</strong> no campo <em>ElfN_Ehdr-&gt;e_type</em> de um arquivo ELF).</p>
<img alt="2e4bd02a99e19c136b20ea5ca7a0ec2c.png" src="img/2e4bd02a99e19c136b20ea5ca7a0ec2c.png"><blockquote>
<p><strong>NOTA</strong>: esse passo tamb√©m pode ser realizado diretamente pelo utilit√°rio gcc, atrav√©s do comando <code>gcc -c hello.c -o hello.o</code>. Atrav√©s desse comando n√£o √© necess√°rio compilar e montar diretamente o arquivo-fonte.</p>
</blockquote>
<p>Por√©m, se tentarmos executar o arquivo-objeto criado a partir da montagem, obtemos o seguinte erro:</p>
<img alt="7787d49ff97ee4c562f2d517529813a2.png" src="img/7787d49ff97ee4c562f2d517529813a2.png"><p>O leitor pode estar se perguntando: &ldquo;mas o arquivo-objeto montado j√° cont√©m dados e c√≥digo, por que n√£o √© poss√≠vel execut√°-lo?&rdquo;. Para explicar melhor essa quest√£o, vamos relembrar a sa√≠da do comando <em>file</em>:</p>
<blockquote>
<p>hello.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped</p>
</blockquote>
<p>O atributo reloc√°vel traz o significado de &ldquo;m√≥vel&rdquo;. Um arquivo-objeto n√£o est√° ligado a outros c√≥digos-objeto e bibliotecas, eles se referem apenas √†quela <a href="https://en.wikipedia.org/wiki/Translation_unit_(programming)">unidade de tradu√ß√£o</a>. Logo, ele n√£o cont√©m c√≥digos externos √†quela unidade de tradu√ß√£o (ou arquivo fonte + diretivas #include), n√£o podendo rodar corretamente. Por√©m, isso permite que ele seja ligado a outros arquivos-objeto para montar um execut√°vel final - por isso o nome &ldquo;reloc√°vel&rdquo;.</p>
<p>Entretanto, n√£o √© poss√≠vel executar o arquivo-objeto at√© mesmo de um c√≥digo m√≠nimo que n√£o possui liga√ß√µes externas. O motivo √© que um arquivo-objeto, devido a ser reloc√°vel, n√£o cont√©m endere√ßamento virtual definido. Podemos checar isso realizando o disassembly da fun√ß√£o mais com um software disassembler, como o <em>objdump</em>:</p>
<img alt="a03c337a0a2025b2a1d277cee919d7a5.png" src="img/a03c337a0a2025b2a1d277cee919d7a5.png"><p>Note que os endere√ßos das instru√ß√µes, destacados em vermelho, est√£o iniciando em endere√ßos muito baixos, partindo do 0, al√©m das refer√™ncias apontarem para endere√ßos que n√£o fazem sentido. Esses valores s√£o como <em>placeholders</em> para serem definidos corretamente na √∫ltima fase: o Linking.</p>
<p>A etapa de linking ir√° unir os arquivos-objetos em um √∫nico execut√°vel, definindo o endere√ßamento virtual de cada se√ß√£o, suas permiss√µes e resolvendo as refer√™ncias de endere√ßos nas instru√ß√µes. Isso √© feito pelo software <em>ld</em>, chamado implicitamente pelo gcc quando o argumento <em>-c</em> n√£o √© passado. Na imagem abaixo √© poss√≠vel verificar que o arquivo final realmente √© execut√°vel e as refer√™ncias de endere√ßos foram devidamente resolvidas.</p>
<img alt="a4cf00eae1ea056e23b6970296312257.png" src="img/a4cf00eae1ea056e23b6970296312257.png"><h2 id="tipos-de-linking">Tipos de linking<a href="#tipos-de-linking" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Nas se√ß√µes anteriores foi explicado o processo da gera√ß√£o de um execut√°vel. Entretanto, a fase de linking tem suas particularidades, em especial para a Seguran√ßa da Informa√ß√£o. H√° tr√™s tipos de linking principais que mais encontramos nos programas para sistemas operacionais atuais: linking est√°tico (<em>static linking</em>), linking din√¢mico (<em>dynamic linking</em>) e linking em tempo de execu√ß√£o (<em>runtime linking</em>). Nas se√ß√µes abaixo ser√£o explanados os tipos de linking, suas caracter√≠sticas e como realiz√°-los em GNU/Linux e Windows.</p>
<p>Para todos os exemplos, a n√£o ser que explicitamente falado, utilizaremos como base os seguintes arquivos-fonte:</p>
<p><strong>main.c</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;mymath.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="nf">soma</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;A soma eh %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>mymath.c</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;mymath.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">soma</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>mymath.h</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">soma</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>
</span></span></code></pre></div><p>O objetivo √© compilar essa solu√ß√£o com os diversos tipos de linking, que resultar√° em um execut√°vel (<em>main.c</em>) que chama o c√≥digo dispon√≠vel em <em>mymath.c</em>. <em>mymath.c</em> ser√° a biblioteca utilizada para demonstrar os tipos de linking. Especificamente, ser√° realizada uma chamada √† fun√ß√£o <em>soma(int, int)</em> que ir√° retornar a soma de dois inteiros.</p>
<h3 id="static-linking">Static Linking<a href="#static-linking" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>O linking est√°tico ocorre quando o c√≥digo de uma biblioteca tem suas fun√ß√µes e dados &ldquo;copiados&rdquo; para o execut√°vel final. A biblioteca √© chamada de biblioteca est√°tica (extens√£o <em>.a</em> em GNU/Linux e <em>.lib</em> em Windows) e ela ser√° composta de uma s√©rie de arquivos-objeto que a implementam. De fato, em especial no Linux, a biblioteca √© apenas um <em>archive</em>, ou um arquivo composto de diversos outros arquivos, criado pelo software <em>ar</em>.</p>
<p>Nesse tipo de linking, n√£o h√° depend√™ncias de runtime, pois o execut√°vel gerado j√° ir√° conter todo o c√≥digo necess√°rio para execu√ß√£o.</p>
<h4 id="elf">ELF<a href="#elf" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>No diagrama abaixo est√£o representados os passos para a constru√ß√£o de um execut√°vel ELF usando <em>static linking</em>.</p>
<img alt="0a072b93add655e7e5e3ff13bac4a46b.png" src="img/0a072b93add655e7e5e3ff13bac4a46b.png"><p>Primeiramente iremos gerar os arquivos-objeto dos dois arquivos principais, <em>main.c</em> e <em>mymath.c</em>:</p>
<blockquote>
<p><code>gcc -c main.c mymath.c</code></p>
</blockquote>
<img alt="c8ac9cd7bd3491eb47571e7618d3e5ec.png" src="img/c8ac9cd7bd3491eb47571e7618d3e5ec.png"><p>Agora, temos que criar a biblioteca est√°tica via software <em>ar</em>, o archiver do projeto GNU. Lembrando que a biblioteca est√°tica nada mais √© que um <em>archive</em> contendo uma s√©rie de arquivos-objeto que a implementam. Para fins de compila√ß√£o via gcc, √© recomend√°vel que a biblioteca criada tenha o nome de <strong>libnomedabiblioteca.a</strong>. No nosso caso, <em>libmymath.a</em>.</p>
<blockquote>
<p><code>ar rcs libmymath.a mymath.o</code></p>
</blockquote>
<img alt="3091abe2ead637432833880e4be8f18b.png" src="img/3091abe2ead637432833880e4be8f18b.png"><p>Ap√≥s a gera√ß√£o da biblioteca, s√≥ precisamos linkar o objeto <em>main.o</em> com a biblioteca e gerar o execut√°vel final. O par√¢metro <em>-L</em> do gcc especifica uma localiza√ß√£o adicional na qual deve ser pesquisada as bibliotecas n√£o encontradas em caminhos-padr√£o do sistema. Nesse caso, adicionamos a localiza√ß√£o do diret√≥rio atualmente aberto. Por fim, o par√¢metro <em>-l</em> especifica uma biblioteca a ser linkada, no formato <em>libmymath.a</em> (quando especificado apenas como <em>-lnomedabiblioteca</em>, o gcc ir√° procurar pela bibliteca <em>libnomedabiblioteca.a</em>).</p>
<blockquote>
<p><code>gcc -o main main.o -L./ -lmymath</code> ou <code>gcc -o main main.o -L./ -l:libmymath.a</code></p>
</blockquote>
<img alt="4f0f416aa1588c1ab3b03da6555390d9.png" src="img/4f0f416aa1588c1ab3b03da6555390d9.png"><p>Podemos utilizar o software <em>ldd</em>, que checa por informa√ß√µes de bibliotecas din√¢micas em um bin√°rio e n√£o encontramos o nome da libmymath:</p>
<img alt="d1d6ad28a4c941fd01e50afe054bd775.png" src="img/d1d6ad28a4c941fd01e50afe054bd775.png"><p>Isso demonstra que, pelo menos para essa biblioteca, o linking ocorrido foi do tipo est√°tico. H√° ainda bibliotecas din√¢micas pois utilizamos a biblioteca padr√£o <em>libc</em> para prover fun√ß√µes de I/O, com o <em>printf</em>. Em GNU/Linux √© poss√≠vel gerar um execut√°vel 100% linkado estaticamente devido ao n√∫mero das syscalls n√£o mudarem - toda fun√ß√£o implementada em C passa necessariamente por uma ou mais syscalls. Dessa forma, a gera√ß√£o fica facilitada pois para o compilador √© necess√°rio apenas conhecer os n√∫meros das syscalls e seus argumentos para gerar um bin√°rio est√°tico.</p>
<p>Para gerar um bin√°rio 100% est√°tico, basta adicionar <em>-static</em> na linha de gera√ß√£o do execut√°vel. Verificando com o <em>ldd</em>, √© retornado que o bin√°rio n√£o √© din√¢mico:</p>
<img alt="fda2c0b2f06ec1cb61e25bebaf7ec193.png" src="img/fda2c0b2f06ec1cb61e25bebaf7ec193.png"><h4 id="pe">PE<a href="#pe" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>No diagrama abaixo est√£o representados os passos para a constru√ß√£o de um execut√°vel PE usando <em>static linking</em>.</p>
<img alt="83c263d08d2b409e063908b1a3774f7d.png" src="img/83c263d08d2b409e063908b1a3774f7d.png"><p>O processo √© semelhante ao ELF, mas nesse caso utillizaremos o compilador de C/C++ da microsoft (<em>cl.exe</em>), dispon√≠vel no <a href="https://visualstudio.microsoft.com/vs/community/">Visual Studio Community</a>, na op√ß√£o de &ldquo;Desenvolvimento para desktop com C++ &quot; e acess√≠vel via &ldquo;Developer Powershell for VS 2022&rdquo;</p>
<img alt="a93049b5d97da6955944b6374a9ec7ae.png" src="img/a93049b5d97da6955944b6374a9ec7ae.png"><p>O passo-a-passo segue abaixo, com a compila√ß√£o do <em>main.c</em> e <em>mymath.c</em> para arquivos-objeto (<em>.obj</em> no Windows):</p>
<blockquote>
<p><code>cl.exe /c main.c mymath.c</code></p>
</blockquote>
<img alt="54b052380d95f45d30149a3cce50a2d5.png" src="img/54b052380d95f45d30149a3cce50a2d5.png"><p>A gera√ß√£o da biblioteca est√°tica √© feita a partir da ferramenta <em>lib.exe</em>, indicando o arquivo-objeto criado. O nome da lib ficar√° como <em>mymath.lib</em>:</p>
<blockquote>
<p><code>lib.exe .\mymath.obj</code></p>
</blockquote>
<img alt="da51fe122d5d5265e27e0bf22d7e4197.png" src="img/da51fe122d5d5265e27e0bf22d7e4197.png"><p>Por fim, chamaremos a ferramenta <em>link.exe</em>, o linker do Visual Studio, para gerar o execut√°vel final:</p>
<blockquote>
<p><code>link.exe main.obj mymath.lib</code></p>
</blockquote>
<img alt="c7ca0764a57b49ea89ffb2be033d3ede.png" src="img/c7ca0764a57b49ea89ffb2be033d3ede.png"><p>Verificando a Import Table do EXE com o software <a href="https://github.com/horsicq/Detect-It-Easy">Detect It Easy</a>, √© poss√≠vel perceber que n√£o h√° depend√™ncias com rela√ß√£o ao c√≥digo implementado.</p>
<img alt="dcde4feb84220852205be7c6e2f5c13e.png" src="img/dcde4feb84220852205be7c6e2f5c13e.png"><p>Note que h√° a depend√™ncia ainda da <em>KERNEL32.DLL</em>. Isso se deve ao fato de que no Windows as syscalls n√£o s√£o chamadas diretamente: os c√≥digos dever√£o executar fun√ß√µes da <em>ntdll.dll</em> que ir√£o chamar as syscalls. <em>Kernel32.dll</em> √© uma biblioteca &ldquo;mais alto n√≠vel&rdquo; que a <em>ntdll.dll</em>, mais est√°vel e documentada, e que chama a <em>ntdll.dll</em> para executar suas pr√≥prias fun√ß√µes.</p>
<p>Esse design dos componentes permite que o sistema operacional mude o n√∫mero das syscalls sem impactar os softwares, e o n√∫mero das syscalls pode mudar em uma atualiza√ß√£o do Windows. Logo, o compilador n√£o ir√° saber os n√∫meros das syscalls a serem chamadas, necessitando chamar a <em>Kernel32.dll</em> (nesse caso) como API para suprir essa falta de n√∫mero das syscalls. √â por isso que comumente n√£o encontramos bin√°rios est√°ticos para Windows, pois o n√∫mero das syscalls pode mudar a qualquer momento, n√£o sendo confi√°vel para um compilador utiliz√°-las.</p>
<h3 id="dynamic-linking-load-time-dynamic-linking">Dynamic Linking (load-time Dynamic Linking)<a href="#dynamic-linking-load-time-dynamic-linking" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>O linking est√°tico permite rodar um c√≥digo sem depend√™ncias, por√©m seu uso traz algumas desvantagens:</p>
<ul>
<li>O execut√°vel final ir√° conter o c√≥digo da biblioteca, acarretando em um tamanho maior do c√≥digo;</li>
<li>Quando houver uma atualiza√ß√£o na biblioteca, ser√° necess√°rio recompilar tamb√©m o c√≥digo do execut√°vel final.</li>
</ul>
<p>A solu√ß√£o para esses problemas √© adicionar uma depend√™ncia de runtime, uma biblioteca din√¢mica. Seu c√≥digo n√£o ir√° compor o execut√°vel final, mas ir√° ter uma refer√™ncia nas <em>Import Tables</em> dos arquivos PE (e sua contraparte ELF, a se√ß√£o <em>.dynsym</em>).</p>
<p>A fase de linking tamb√©m ser√° diferente, pois n√£o haver√° a c√≥pia do c√≥digo para o execut√°vel, mas ir√£o ser criados JMPs para se√ß√µes especiais, como a <em>.plt</em> e a Global Offset Table (GOT) nos execut√°veis ELF. Qualquer chamada a c√≥digo externo ir√° resultar em um JMP para se√ß√£o <em>.plt</em>, que ir√° chamar um stub de c√≥digo especial que ir√° recuperar o endere√ßo da fun√ß√£o externa na GOT.</p>
<p>Para executar o c√≥digo final ser√° necess√°rio que a biblioteca esteja em um local padr√£o procurado pelo sistema operacional, ou adicionado via vari√°veis de ambiente, como veremos nas pr√≥ximas se√ß√µes.</p>
<h4 id="elf-1">ELF<a href="#elf-1" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>No diagrama abaixo est√£o representados os passos para a constru√ß√£o de um execut√°vel ELF usando <em>dynamic linking</em>.</p>
<img alt="1eb8a6ff3c59c68da7b01adaa76c3b08.png" src="img/1eb8a6ff3c59c68da7b01adaa76c3b08.png"><p>O passo-a-passo para compilar uma solu√ß√£o com <em>dynamic linking</em> est√° descrito abaixo:</p>
<ol>
<li>compila√ß√£o de <em>main.c</em> para arquivo objeto (<code>gcc -c main.c</code>);</li>
<li>compila√ß√£o da <em>mymath.c</em> na biblioteca din√¢mica <em>libmymath.so</em>. Esse processo necessita dos par√¢metros <em>-fPIC</em> e <em>-shared</em> para permitir que o bin√°rio resultante tenha <em>Position Independent Code</em>, que permite um bin√°rio ser carregado em qualquer endere√ßo na mem√≥ria (e n√£o s√≥ aquele definido no processo de compila√ß√£o), e que esse bin√°rio √© um objeto compartilhado (shared object);</li>
</ol>
<p>Ap√≥s esses dois passos, exemplificados na imagem abaixo, podemos checar com o comando <em>file</em> que realmente a biblioteca gerada √© um <em>shared object</em>, e n√£o mais um simples arquivo composto de arquivos-objeto.</p>
<img alt="77b3e851c98e4a11fe9ac552a4ea2516.png" src="img/77b3e851c98e4a11fe9ac552a4ea2516.png"><p>O execut√°vel deve ser criado utilizando a op√ß√£o <em>-L</em>, especificando o diret√≥rio atual (<em>./</em>). Isso faz com que o linker procure por bibliotecas tamb√©m no diret√≥rio especificado. Essa op√ß√£o, em conjunto com <em>-lmymath</em>, faz com que o linker procure e encontre o arquivo <em>libmymath.so</em>, realizando o linking din√¢mico. O linking din√¢mico pode ser evidenciado a partir da ferramenta <em>ldd</em>, que lista as bibliotecas din√¢micas utilizadas por um bin√°rio n√£o est√°tico:</p>
<img alt="d55aeaf58bd50dde34f6f3f582794783.png" src="img/d55aeaf58bd50dde34f6f3f582794783.png"><p>Note, por√©m, que o sotware n√£o encontrou a biblioteca especificadada. A tentativa de execu√ß√£o pelo meio convencional tamb√©m ir√° resultar em falha, conforme imagem abaixo. Isso se deve ao fato de que o loader procura por bibliotecas din√¢micas em locais padr√£o do sistema operacional.</p>
<img alt="2041e21596ded757db806fc84f3767aa.png" src="img/2041e21596ded757db806fc84f3767aa.png"><p>Para especificar um diret√≥rio n√£o padr√£o, podemos utilizar a vari√°vel de ambiente <em>LD_LIBRARY_PATH</em>, passando um ponto para especificar o diret√≥rio padr√£o. Conforme imagem abaixo, √© poss√≠vel verificar que tanto o ldd quanto a execu√ß√£o do bin√°rio funcionam corretamente ap√≥s a defini√ß√£o dessa vari√°vel:</p>
<img alt="3428ff172fa38c2488cbf0bf382c0e83.png" src="img/3428ff172fa38c2488cbf0bf382c0e83.png"><h4 id="pe-1">PE<a href="#pe-1" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>No diagrama abaixo est√£o representados os passos para a constru√ß√£o de um execut√°vel PE usando <em>dynamic linking</em>.</p>
<img alt="29604c65d3b9a736cc49ff67c88afb23.png" src="img/29604c65d3b9a736cc49ff67c88afb23.png"><p>Para esse exemplo, utilizaremos o seguinte conte√∫do para o arquivo <em>mymath.c</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;mymath.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="nf">soma</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>e para o arquivo <em>mymath.h</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="nf">soma</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>
</span></span></code></pre></div><p>Isso √© necess√°rio para declarar a fun√ß√£o <em>soma(int, int)</em> como um export da biblioteca din√¢mica gerada, e, logo, acess√≠vel externamente.</p>
<p>O primeiro passo, como em outros anteriores, √© a constru√ß√£o dos arquivos-objeto. Nesse caso, utilizaremos o <em>cl.exe /c main.c mymath.c</em> para ger√°-los de uma s√≥ vez. Isso ir√° criar os arquivos de nome <em>main.obj</em> e <em>mymath.obj</em>:</p>
<img alt="e4628cded96d729c7454cc5dbd3e4587.png" src="img/e4628cded96d729c7454cc5dbd3e4587.png"><p>Para criar uma biblioteca din√¢mica, ou DLL, no Windows, podemos utilizar a ferramenta <em>link.exe</em> com a linha de comando <em>link.exe /DLL mymath.obj</em>. Isso ir√° criar 3 arquivos: <em>mymath.dll</em>, <em>mymath.lib</em> e <em>mymath.exp</em>. Para nosso artigo, iremos focar em <em>mymath.dll</em> e <em>mymath.lib</em>.</p>
<img alt="83d9918b8a8030626e2eadc70ac9e202.png" src="img/83d9918b8a8030626e2eadc70ac9e202.png"><p>O linking din√¢mico no Windows √© um pouco diferente da sua contraparte Linux. Iremos utilizar a ferramenta <em>link.exe</em> para linkar o <em>main.obj</em> com a <em>mymath.lib</em>, atrav√©s da linha de comando <em>link.exe main.obj mymath.lib</em>. Isso pode soar como um linking est√°tico, mas n√£o √©! Esse arquivo <em>.lib</em> ir√° conter as informa√ß√µes necess√°rias para se linkar um c√≥digo dinamicamente com <em>mymath.dll</em>, e esta, por sua vez, ir√° compor a depend√™ncia em runtime do bin√°rio. Em resumo: para compilar, devemos utilizar a <em>mymath.lib</em> e para rodar precisaremos da <em>mymath.dll</em> em um dos <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order">diret√≥rios padr√£o para busca de DLLs</a>.</p>
<p>Como a DLL Search Order tem como um dos seus diret√≥rios de busca o diret√≥rio corrente ou do bin√°rio, a execu√ß√£o n√£o necessitar√° de nada al√©m da <em>mymath.dll</em> para funcionar:</p>
<img alt="3f5e7f5bee81850b08e3cf60fe5c659c.png" src="img/3f5e7f5bee81850b08e3cf60fe5c659c.png"><p>Utilizando o sotware Detect It Easy, √© poss√≠vel verificar que h√° uma entrada na Import Table do execut√°vel que representa a fun√ß√£o externa utilizada e a DLL. Isso caracteriza o linking din√¢mico.</p>
<img alt="853a8a6e530d18f7afa6ca46a55760b4.png" src="img/853a8a6e530d18f7afa6ca46a55760b4.png"><h3 id="runtime-linking-run-time-dynamic-linking">Runtime Linking (run-time Dynamic Linking)<a href="#runtime-linking-run-time-dynamic-linking" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>O runtime dynamic linking envolve o uso de uma biblioteca din√¢mica mas n√£o gera uma entrada na <em>Import Table</em> ou <em>.dynsym</em>. Isso √© poss√≠vel pois a biblioteca din√¢mica, diferentemente do dynamic linking tradicional, √© linkada em tempo de runtime e n√£o de compila√ß√£o. S√£o utilizadas fun√ß√µes especiais para recuperar os endere√ßos das subrotinas requeridas e ponteiros para fun√ß√µes s√£o instanciados para execut√°-las. Como a forma de obter essas informa√ß√µes em runtime dependem do formato de arquivo e at√© de componentes do sistema operacional, geralmente s√£o escritos c√≥digos diferentes para sistemas operacionais diferentes.</p>
<h4 id="elf-2">ELF<a href="#elf-2" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>No diagrama abaixo est√£o representados os passos para a constru√ß√£o de um execut√°vel ELF usando <em>runtime linking</em>.</p>
<img alt="1db0c4cacbe404da15203596254e1f45.png" src="img/1db0c4cacbe404da15203596254e1f45.png"><p>Abaixo est√° o c√≥digo <em>main.c</em> utilizado para o runtime linking.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">soma_func</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span> <span class="n">mymath_handle</span> <span class="o">=</span> <span class="nf">dlopen</span><span class="p">(</span><span class="s">&#34;libmymath.so&#34;</span><span class="p">,</span> <span class="n">RTLD_LAZY</span> <span class="o">|</span> <span class="n">RTLD_GLOBAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">mymath_handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ERROR: dlopen!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;libmymath.so loaded!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">soma_func</span> <span class="n">sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">soma_func</span><span class="p">)</span> <span class="nf">dlsym</span><span class="p">(</span><span class="n">mymath_handle</span><span class="p">,</span> <span class="s">&#34;soma&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">sum</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ERROR: dlsym!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;soma() found!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The sum is: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="nf">dlclose</span><span class="p">(</span><span class="n">mymath_handle</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ERROR: dlclose!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;libmymath.so handle closed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Podemos copiar a <em>libmath.so</em> gerada no dynamic linking para o diret√≥rio de exemplo do runtime linking para n√£o termos que recompil√°-la. Para compilar o novo arquivo <em>main.c</em>, devemos passar para o gcc a biblioteca de linking din√¢mico, que cont√©m as fun√ß√µes necess√°rias para realizar a pesquisa e recupera√ß√£o dos endere√ßos dos s√≠mbolos dispon√≠veis na biblioteca de exemplo.</p>
<blockquote>
<p><code>gcc -o main main.c -ldl</code></p>
</blockquote>
<p>Conforme exemplificado na imagem a seguir, o bin√°rio foi gerado com sucesso mas sua execu√ß√£o por si s√≥ resulta em erro. Esse √© o mesmo caso que explicamos no dynamic linking, resolvido com o uso da vari√°vel de ambiente <em>LD_LIBRARY_PATH</em>.</p>
<img alt="ef081ba00b3556c5163f26e8062fa253.png" src="img/ef081ba00b3556c5163f26e8062fa253.png"><p>Seguindo o fluxo de c√≥digo, o c√≥digo da biblioteca <em>libmymath.so</em> √© carregado atrav√©s das fun√ß√µes <em>dlopen</em> e <em>dlsym</em>, para encontrar em mem√≥ria o endere√ßo da fun√ß√£o <em>soma(int, int)</em>. Quando encontrado, √© instanciado um ponteiro para a fun√ß√£o que logo ap√≥s √© chamado, retornando o valor 3. Por fim, a biblioteca √© fechada e o c√≥digo termina.</p>
<img alt="85bfcd604d7fd080feac9e959df71952.png" src="img/85bfcd604d7fd080feac9e959df71952.png"><p>Logo, esse bin√°rio necessita que <em>libmymath.so</em> exista para que sua execu√ß√£o tenha sucesso. Por√©m, se checarmos a sa√≠da do software <em>ldd</em> para esse bin√°rio, verificaremos que n√£o h√° nenhuma entrada para o arquivo <em>libmymath.so</em>. Isso caracteriza runtime linking.</p>
<img alt="2bc1b3980eb3d44e13a663e41a7186c5.png" src="img/2bc1b3980eb3d44e13a663e41a7186c5.png"><h4 id="pe-2">PE<a href="#pe-2" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>No diagrama abaixo est√£o representados os passos para a constru√ß√£o de um execut√°vel PE usando <em>runtime linking</em>.</p>
<img alt="fb6b46ec034c98dbcaa74e3a4a3d66bc.png" src="img/fb6b46ec034c98dbcaa74e3a4a3d66bc.png"><p>Neste exemplo, iremos utilizar o seguinte conte√∫do no arquivo <em>main.c</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">HMODULE</span> <span class="n">mymathDll</span> <span class="o">=</span> <span class="nf">LoadLibraryA</span><span class="p">(</span><span class="s">&#34;mymath.dll&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mymathDll</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ERROR: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">func</span> <span class="n">somaPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="n">mymathDll</span><span class="p">,</span> <span class="s">&#34;soma&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">somaPtr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ERROR: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;A soma eh %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">somaPtr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>No caso de um EXE, para realizar runtime linking √© necess√°rio o uso de APIs como <em>LoadLibrary/GetProcAddress/GetModuleHandle</em> para carregar uma DLL em um ponto do c√≥digo e encontrar a fun√ß√£o que se deseja executar.</p>
<p>Para esse exemplo, podemos copiar a DLL <em>mymath.dll</em> j√° compilada na se√ß√£o de dynamic linking para o diret√≥rio que <em>main.c</em> est√°. Iremos gerar o execut√°vel <em>main.exe</em> atrav√©s da execu√ß√£o da linha de comando <em>cl.exe main.c</em>. Sua execu√ß√£o, caso mymath.dll esteja no mesmo diret√≥rio, n√£o resulta em nenhum problema.</p>
<img alt="9430a4e1ccfb359bcf8d1f50cedbb0f3.png" src="img/9430a4e1ccfb359bcf8d1f50cedbb0f3.png"><p>Na ferramenta DIE √© poss√≠vel verificar que n√£o h√° entradas para a mymath.dll, caracterizando runtime linking.</p>
<img alt="d2c1e671f63d7886c097cf29e351ab79.png" src="img/d2c1e671f63d7886c097cf29e351ab79.png"><h1 id="conclus√£o">Conclus√£o<a href="#conclus√£o" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>Nesse artigo foram abordados os tipos de linking existentes nos principais sistemas operacionais e formatos. No pr√≥ximo artigo dessa s√©rie iremos explorar as possibilidades de transformar esses tipos de linking em capacidades maliciosas (em especial, o runtime linking!).</p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Ler outras postagens</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="http://localhost:1313/posts/base-0x00/index2/" class="button inline prev">
        &lt; [<span class="button__text">Base 0x00 - Procedimento de linking &amp; seus tipos</span>]
      </a>
    
    
      ::
    
    
      <a href="http://localhost:1313/posts/crackme-0x01/" class="button inline next">
         [<span class="button__text">Crackme 0x01 - timotei crackme#7: c√≥digo mutante e porque n√£o devemos confiar apenas na descompila√ß√£o</span>] &gt;
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>Midnight Hackings apoia o fim da escala 6x1!</span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
