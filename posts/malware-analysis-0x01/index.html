<!DOCTYPE html>
<html><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Security Researcher in Reversing/Malware/Low Level fields">
    <meta name="Author" content="Midnight Reverser">
    <meta name="keywords" content="midnighthackings midnight-rev midnight">
    <link rel="stylesheet" href=https://blog.midnighthackings.com/css/syntax.css>
    <link rel="stylesheet" href=https://blog.midnighthackings.com/css/style.css>
    <script src="https://kit.fontawesome.com/1b7478c139.js" crossorigin="anonymous"></script>
    <title>Midnight Hackings - #FimDaEscala6x1</title>
  </head><body><aside id="sidenav">
    <header>
    
        <a href=https://blog.midnighthackings.com/><img src="https://blog.midnighthackings.com/avatar.png" alt="avatar"></a>
        
    

    <a id="branding" href=https://blog.midnighthackings.com/>
        
            Midnight's Home
        
    </a>
    </header>

    <nav>
        
            		
            <a href="/posts"
                
            >
                <i class="fas fa-keyboard fa-ms"></i>
                <span>posts</span>
            </a>
        
            		
            <a href="/tags"
                
            >
                <i class="fas fa-tags fa-ms"></i>
                <span>tags</span>
            </a>
        
            		
            <a href="https://github.com/midnight-rev"
                
                    target="_blank"
                
            >
                <i class="fab fa-github fa-ms"></i>
                <span>github</span>
            </a>
        
            		
            <a href="/index.xml"
                
            >
                <i class="fas fa-rss fa-ms"></i>
                <span>RSS</span>
            </a>
        
            		
            <a href="/contact"
                
            >
                <i class="far fa-envelope"></i>
                <span>contact</span>
            </a>
        
    </nav>
</aside>
<main id="main">
            <a href="javascript:void(0)" id="closebtn" onclick="navToggle()"><i class="fas fa-bars fa-lg"></i></a>
            <div class="content">
<code>
    <center>
    <p style="font-weight: bolder;color: red;"> Midnight Hackings apoia o fim da escala 6x1. </p>
    <p style="font-weight: bolder;color: red;">Todos nós trabalhadores devemos ter direito à vida além do trabalho! Trabalhadores unidos mudam o mundo.</p>
    </center>
</code>
    
    <h1 id="title">Laboratório Seguro para Análise de Malware - Análise de Malware 0x01</h1>
    
    
      
    <nav id="TableOfContents">
  <ul>
    <li><a href="#abordagem-0x00---laboratório-físico">Abordagem 0x00 - Laboratório físico</a></li>
    <li><a href="#abordagem-0x01---laboratório-virtual">Abordagem 0x01 - Laboratório virtual</a></li>
  </ul>

  <ul>
    <li><a href="#download-remnux">Download REMnux</a></li>
    <li><a href="#download-windows">Download Windows</a></li>
    <li><a href="#instalação-das-ferramentas-e-configuração-do-ambiente">Instalação das ferramentas e configuração do ambiente</a>
      <ul>
        <li><a href="#softwares-utilizados">Softwares utilizados</a></li>
        <li><a href="#configuração-do-explorer">Configuração do explorer</a></li>
        <li><a href="#desativação-windows-defender-no-windows-1011">Desativação Windows Defender no Windows 10/11</a></li>
        <li><a href="#desativação-do-firewall">Desativação do Firewall</a></li>
        <li><a href="#desativação-do-user-account-control">Desativação do User Account Control</a></li>
        <li><a href="#desativação-do-windows-update">Desativação do Windows Update</a></li>
      </ul>
    </li>
    <li><a href="#configuração-da-rede">Configuração da rede</a>
      <ul>
        <li><a href="#windows-malware">Windows Malware</a></li>
        <li><a href="#remnux">REMnux</a></li>
        <li><a href="#testando-a-configuração">Testando a configuração</a></li>
      </ul>
    </li>
    <li><a href="#snapshots">Snapshots</a></li>
  </ul>
</nav>
    <blockquote>
<p>Escrito por: Mateus Gualberto (Midnight Reverser)
Licença: livre, como todo conhecimento deve ser.</p>
</blockquote>
<h1 id="introdução">Introdução</h1>
<p>Nesse artigo será apresentada uma abordagem para criação de um laboratório seguro local para análise de artefatos suspeitos ou maliciosos. É recomendado que o leitor siga o passo-a-passo na seção <a href="#passo-a-passo">Passo-a-passo</a> à risca, para evitar qualquer problema de configuração</p>
<p>Para seguir a parte prática desse artigo, é recomendado um computador de 64-bits Intel/AMD (arquitetura <code>amd64/x86-64</code>, não funcionará bem nos hardwares ARM, como MacBooks M1), com pelo menos 8GB de RAM, e um software Hypervisor - recomendamos o <a href="https://www.virtualbox.org/wiki/Downloads">Oracle VirtualBox</a>. A virtualização deve estar disponível e obrigatoriamente ativa no computador que hospedará o laboratório.</p>
<p>O laboratório construído nesse artigo é o alicerce para futuros artigos que tratarão da análise de malwares reais, em especial para análise dinâmica de malwares Windows.</p>
<h1 id="laboratório-para-análise-de-malwares">Laboratório para análise de malwares</h1>
<p>Primeiramente, o leitor deve estar se perguntando, mas o que seria um laboratório para análise de malwares e por que eu devo ter um?</p>
<p>Um laboratório para análise de malwares é um ambiente isolado, reiniciável e sem ligação com dados sensíveis ou importantes do analista/organização (OPSEC), em que arquivos e comandos podem ser analisados estática e dinamicamente de forma segura - sem afetar sua identidade nem comprometer os dados ou ativos da sua organização.</p>
<p>Esse ambiente deve ser construído por qualquer profissional de segurança da informação ou pesquisador que tenha que lidar no cotidiano com arquivos suspeitos. Utilizá-lo trará mais segurança e confiabilidade ao trabalho desempenhado.</p>
<p><strong>Não necessariamente o próprio laboratório é um ambiente seguro!</strong> A interação com ele sim deve ser segura, mas ele por si só tem fraquezas - como softwares vulneráveis rodando; não há nenhum software antivírus, firewalls e configurações de segurança - como o <em>User Account Control</em> (UAC) nele. Qualquer arquivo &ldquo;esquecido&rdquo; ou encontrado após um estado não confiável - como após executar algum código - deve ser tratado com extrema cautela. Em resumo, trate o ambiente como sempre infectado.</p>
<p>Há duas abordagens principais para construção de laboratórios seguros:</p>
<h2 id="abordagem-0x00---laboratório-físico">Abordagem 0x00 - Laboratório físico</h2>
<p>Nesse cenário, é necessário pelo menos uma máquina física que irá executar os softwares maliciosos. Ela não deve estar conectada à rede local padrão de uso cotidiano, podendo estar conectada apenas em uma rede isolada ou sem conexão alguma. É uma abordagem atípica e menos utilizada.</p>
<p>✅ Vantagens desse modelo:</p>
<ul>
<li>Malwares executarão em um computador real, logo qualquer medida anti-virtualização ou anti-sandbox presentes não serão executadas. Isso permite rodar o malware como ele foi projetado para infectar uma máquina;</li>
<li>As máquinas utilizadas para análise podem ser mais fracas, caso sejam utilizadas para tarefas de análise menos intensivas e mais observacionais - como análise comportamental.</li>
</ul>
<p>❌ Desvantagens:</p>
<ul>
<li>Necessário aquisição de máquinas reais, como notebooks ou PCs, que serão utilizadas apenas para a finalidade de análise;</li>
<li>Há custos, também, com dispositivos de armazenamento externos, como SSDs, para restauração das imagens limpas após infecção;</li>
<li>A restauração das imagens é um processo lento e que necessita de softwares especiais;</li>
<li>É necessário acesso físico ao laboratório - exceto caso seja realizado uma configuração de VPN + Firewall rigorosos para liberação de acesso externo.
<ul>
<li>Entretanto, mesmo nesse caso, a restauração do sistema necessitaria de acesso físico ao laboratório.</li>
</ul>
</li>
</ul>
<h2 id="abordagem-0x01---laboratório-virtual">Abordagem 0x01 - Laboratório virtual</h2>
<p>Nesse cenário, um laboratório mínimo pode ser criado através da instalação de uma máquina virtual Windows através de um Hypervisor (residente em um computador &ldquo;host&rdquo;), que contém todas as ferramentas, mas tem sua conexão de rede isolada ou desconectada totalmente. Essa configuração é a padrão utilizada por analistas de malware.</p>
<p>✅ Vantagens de se construir um laboratório virtual:</p>
<ul>
<li>Custo baixo para construção, caso já se tenha um notebook/computador mediano (8GB de RAM e um bom processador). Licenças do Windows podem não ser necessárias caso se trabalhe com VMs pré-licenciadas ou utilize o período de trial do Windows;</li>
<li>Isolamento das máquinas do laboratório e construção de redes facilitado;</li>
<li>Possibilidade de criação de snapshots - ou seja, capturas de um estado do Sistema Operacional, discos, configurações, etc;</li>
<li>Possibilidade de migração do laboratório para outras máquinas, além da mobilidade caso o laboratório esteja em um notebook;</li>
<li>Velocidade e facilidade em todos os sentidos: construção, restauração de estado limpo pós-infecção, dumps de memória;</li>
<li>É possível criar uma configuração avançada mais facilmente com VPN + Firewall para acesso remoto seguro às VMs - ou até mesmo rodar o ambiente na nuvem. Com acesso também ao host por um meio remoto seguro é possível gerenciar os snapshots facilmente e restaurar o ambiente sempre que necessário.</li>
</ul>
<p>❌ Desvantagens:</p>
<ul>
<li>Rotinas anti-virtualização e anti-sandbox serão um problema que deverá ser identificado e resolvido pelo analista de malware;</li>
<li>Caso o computador host seja muito antigo, rodar uma ou mais VMs pode levar a lentidão generalizada e até mesmo impossibilidade de rodá-las.</li>
</ul>
<p>A abordagem virtual é a que iremos seguir nesse artigo.</p>
<h1 id="arquitetura-do-laboratório-virtual">Arquitetura do laboratório virtual</h1>
<p>Com o objetivo de complementar as análises realizadas através da emulação de protocolos (para casos de análise de troca de informações com o C2, por exemplo), torna-se necessário adicionar uma máquina virtual a mais no laboratório, além da máquina Windows. Adicionaremos  uma máquina GNU/Linux, também isolada, mas inserida nesse ambiente e com conectividade para a máquina Windows.</p>
<blockquote>
<p>Por que não fazer a análise de pacotes de rede usando o próprio host vítima? Para uma boa parte dos casos, não há problemas em realizar a emulação no próprio host - e existem ferramentas para isso, como o <a href="https://www.telerik.com/fiddler"><em>Fiddler</em></a>.</p>
<p>Entretanto, caso o malware aplique técnicas que alterem como os pacotes são enviados através das APIs padrão (ou nem utilize-as), ferramentas de captura de pacotes podem não ser suficientes para identificar e decodificar esses pacotes. Além disso,  ferramentas para emulação de serviços e redirecionamento como o <em>fakenet</em>, <em>fakedns</em>, <em>inetsim</em> e muitas outras já têm versões para Linux facilmente instaláveis.</p>
</blockquote>
<p><img src="img/c93f228afa375892231e371d137ba91e.png" alt="c93f228afa375892231e371d137ba91e.png"></p>
<p>Nesse diagrama, temos a máquina Host, que executará um Hypervisor. Nesse hypervisor, teremos:</p>
<ul>
<li>Duas máquinas virtuais: uma Windows (Windows Malware), em que a maioria das análises serão realizadas, e uma Linux, em que serviços serão simulados e haverá a captura de pacotes de rede. A distribuição que utilizaremos para esse fim é a REMnux, distro que conta com dezenas de ferramentas de análise de malware;</li>
<li>Uma rede interna (VirtualBox) ou Host Only <strong>sem adaptador de rede no host</strong> (VMware, não padrão, necessário criar essa rede no gerenciador de redes). Essa rede irá interligar o host Windows com o Linux, mas não permitirá tráfego para o Host, a rede doméstica em que ele está inserido e à Internet;</li>
</ul>
<h1 id="passo-a-passo">Passo-a-passo</h1>
<p>Nessa seção será mostrado um passo-a-passo para a construção e configuração do laboratório no VirtualBox. É necessário que o leitor tenha conhecimento prévio do processo de virtualização, do hypervisor utilizado - caso queira utilizar outro que não seja o VirtualBox - além do processo de instalação comum de um Sistema Operacional.</p>
<h2 id="download-remnux">Download REMnux</h2>
<p>O REMnux pode ser obtido <a href="https://docs.remnux.org/install-distro/get-virtual-appliance">por esse link</a>. Faça o download da OVA do VirtualBox e tenha certeza que a extensão do arquivo é <em>.ova</em> antes de prosseguir para o próximo passo.</p>
<p><img src="img/f6a8ed532389bb04d5d6d102b50db075.png" alt="f6a8ed532389bb04d5d6d102b50db075.png"></p>
<p>Após obter a OVA, acesse a opção <code>File &gt; Import Appliance</code> no VirtualBox e selecione a OVA. Deixe as opções padrão em <em>Settings</em> durante a importação, ou, caso deseje, altere os valores de RAM e CPU. Conclua a importação e siga os próximos passos.</p>
<p><img src="img/76986e183f0cfc9c38b5102c0797c1eb.png" alt="76986e183f0cfc9c38b5102c0797c1eb.png"></p>
<p><img src="img/4ffdc497f0adeeb53630e71ebfedd0b9.png" alt="4ffdc497f0adeeb53630e71ebfedd0b9.png"></p>
<h2 id="download-windows">Download Windows</h2>
<p>Faça o download da ISO do Windows 10 através <a href="https://www.microsoft.com/pt-br/software-download/windows10">desse link</a>. A página irá redirecionar para o download de uma ISO caso seu Sistema Operacional seja diferente de Windows, e para o download de um software criador de ISOs Windows, caso contrário.</p>
<p><img src="img/88d8e6cfe5cd96d7bda005ff33956837.png" alt="88d8e6cfe5cd96d7bda005ff33956837.png"></p>
<blockquote>
<p>Caso deseje, é possível utilizar Windows 11 - vantajoso devido a deprecação do Windows 10 ainda esse ano. Porém, como veremos à frente, a desativação do Windows Defender é mais complexa no Windows 11, por isso que foi decidido a instalação do Windows 10 nesse laboratório.</p>
</blockquote>
<p>Crie a máquina Windows como o de costume: configure a RAM, processadores e disco, e pule a instalação desassistida. É recomendado pelo menos 4GB de RAM, 2 processadores e 70GB de disco.</p>
<p><img src="img/147efefb7887a2ec3c3a5f916e6b0c41.png" alt="147efefb7887a2ec3c3a5f916e6b0c41.png"></p>
<p><img src="img/c690db07bc931576717e34936ddf5131.png" alt="c690db07bc931576717e34936ddf5131.png"></p>
<p><img src="img/94a639469b153423f2600f50de8db3e0.png" alt="94a639469b153423f2600f50de8db3e0.png"></p>
<p>Siga a instalação do Windows normalmente, porém não faça login com uma conta Microsoft; crie uma conta local.</p>
<h2 id="instalação-das-ferramentas-e-configuração-do-ambiente">Instalação das ferramentas e configuração do ambiente</h2>
<h3 id="softwares-utilizados">Softwares utilizados</h3>
<p>A maior parte das nossas ferramentas será instalada automaticamente através do <a href="https://github.com/mentebinaria/retoolkit">projeto retoolkit</a>. Faça o download da release mais recente e execute o EXE.</p>
<blockquote>
<p>É provável que o download seja marcado como não seguro devido à natureza das ferramentas contidas no pacote. Prossiga com a instalação normalmente.</p>
</blockquote>
<p>A instalação padrão já é satisfatória para o laboratório. Caso queira mudar a localização padrão da instalação, recomendamos que seja colocado em <code>C:\retoolkit</code>, para facilitar a localização das ferramentas.</p>
<p><img src="img/4e3390f5dd3148f1765faf82ec56cfc3.png" alt="4e3390f5dd3148f1765faf82ec56cfc3.png"></p>
<p>Além do retoolkit, faça o download dos seguintes softwares:</p>
<ul>
<li>Regshot (<a href="https://sourceforge.net/projects/regshot/">https://sourceforge.net/projects/regshot/</a>)</li>
</ul>
<p>Extraia apenas o <em>Regshot-x64-Unicode.exe</em>, os demais não são necessários.</p>
<p><img src="img/04d14bfae4905429729ad104892f75af.png" alt="04d14bfae4905429729ad104892f75af.png"></p>
<ul>
<li>Sysinternals (<a href="https://download.sysinternals.com/files/SysinternalsSuite.zip">https://download.sysinternals.com/files/SysinternalsSuite.zip</a>)</li>
</ul>
<p>Baixe e extraia os arquivos <em>Autoruns64.exe</em> e <em>Procmon64.exe</em>.</p>
<p><img src="img/fb20ba54138c8d342692efc82de87737.png" alt="fb20ba54138c8d342692efc82de87737.png"></p>
<ul>
<li>Process Hacker System Informer (<a href="https://sourceforge.net/projects/systeminformer/files/systeminformer-3.2.25011-release-setup.exe/download">https://sourceforge.net/projects/systeminformer/files/systeminformer-3.2.25011-release-setup.exe/download</a>)</li>
</ul>
<p>Baixe e execute o instalador.</p>
<ul>
<li>Visual Studio Code (<a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a>)</li>
</ul>
<p>Baixe e execute o instalador. O Visual Studio Code ajudará na construção de scripts simples durante a extração de configuração de certos malwares, por exemplo.</p>
<p>Também é importante instalar pacotes de uma linguagem de programação, como o <a href="https://www.python.org/">Python</a>. Entretanto, sinta-se livre para instalar a(s) linguagem(ns) de programação que preferir.</p>
<h3 id="configuração-do-explorer">Configuração do explorer</h3>
<p>Na configuração do explorer, na aba <em>View</em>, é interessante deixar todas as três checkboxes abaixo ativas, para mostrar as extensões dos arquivos e arquivos ocultos. Isso ajudará a identificar mais facilmente arquivos dropados.</p>
<p><img src="img/d59ab5d7bc517794b59b6be43a025e64.png" alt="d59ab5d7bc517794b59b6be43a025e64.png"></p>
<h3 id="desativação-windows-defender-no-windows-1011">Desativação Windows Defender no Windows 10/11</h3>
<p>A desativação do Windows Defender é essencial para a análise dos malwares. Não podemos deixar que um antivírus atrapalhe as análises, remova nossas ferramentas e scripts e faça ações automáticas, como bloqueio e envio de arquivos suspeitos para a Microsoft.</p>
<h4 id="windows-10---desativação-via-gpeditmsc">Windows 10 - Desativação via gpedit.msc</h4>
<p>Essa técnica é a mais comum para Windows 10, mas nem sempre funciona - provavelmente devido a certas configurações gerados durante a instalação/builds específicas do SO.</p>
<p>Para usar essa técnica:</p>
<ul>
<li>Pesquise por <em>gpedit.msc</em> no Windows, ou use Win+R para executá-lo diretamente;</li>
<li>Navegue em <em>Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Microsoft Defender Antivirus</em> e deixe selecionado &ldquo;Microsoft Defender Antivirus&rdquo; - não expanda-o;</li>
</ul>
<p><img src="img/02580f2a6cbfe5c02b78019087e68870.png" alt="02580f2a6cbfe5c02b78019087e68870.png"></p>
<p><img src="img/39659239acbc373797e740f8da9b7466.png" alt="39659239acbc373797e740f8da9b7466.png"></p>
<ul>
<li>Clique duas vezes em &ldquo;Turn off Microsoft Defender Antivirus&rdquo; e deixe ativado;</li>
</ul>
<p><img src="img/bdc569ba9c5708cd92b04896d6292701.png" alt="bdc569ba9c5708cd92b04896d6292701.png"></p>
<ul>
<li>Após um reboot, verifique se as configurações de &ldquo;Virus &amp; threat protection&rdquo; estejam desativadas, como na imagem abaixo.</li>
</ul>
<p><img src="img/511ce501c58b0f1d928104ac0e42504c.png" alt="511ce501c58b0f1d928104ac0e42504c.png"></p>
<p>Caso a desativação não funcione, é recomendável testar o método de <a href="#windows-11-desativa%C3%A7%C3%A3o-via-safe-boot">desativação no Windows 11</a>. Ele deve funcionar corretamente.</p>
<h4 id="windows-11---desativação-via-safe-boot">Windows 11 - Desativação via safe boot</h4>
<p>Essa técnica foi compartilhada pelo OALabs no seu vídeo de criação de um ambiente de análise de malware em macs M1 (quem sabe, em breve, tenhamos um artigo sobre?). <a href="https://youtu.be/0eR8yrDLV5M?t=675&amp;si=FKsJW2MuWuMRPaD6">Clique aqui</a> para acessar o vídeo na minutagem em que começa a remoção do Windows Defender.</p>
<p>Em resumo: essa técnica consiste em mudar as permissões de <code>C:\ProgramData\Microsoft\Windows Defender</code> para que ninguém, nem mesmo Administrators ou SYSTEM tenha acesso ao diretório, evitando o funcionamento correto do Windows Defender.</p>
<p>Segue o passo-a-passo:</p>
<p>Execute <em>msconfig.exe</em> e vá na aba de Boot. Selecione <em>Safe boot</em> e clique em OK. Após isso, reinicie o computador.</p>
<p><img src="img/ee28c6631df06f77f770874dbf1e8fdf.png" alt="ee28c6631df06f77f770874dbf1e8fdf.png"></p>
<p>Quando a máquina reiniciar, ela não terá carregado vários drivers e o leitor terá um privilégio alto nos diretórios sensíveis do Windows.</p>
<p><img src="img/24e5e7ce736193a062299132b3c1e12b.png" alt="24e5e7ce736193a062299132b3c1e12b.png"></p>
<p>No explorer, vá até <code>C:\ProgramData\Microsoft\</code>, selecione o diretório <code>Windows Defender</code> e clique em propriedades.</p>
<p><img src="img/036aabb666e3c03e173cedfafd7e150c.png" alt="036aabb666e3c03e173cedfafd7e150c.png"></p>
<p>Na aba Security, clique em <em>Advanced</em>:</p>
<p><img src="img/bfc749aafa4445ad2b117df24672604b.png" alt="bfc749aafa4445ad2b117df24672604b.png"></p>
<p>Na janela que abrir, clique para mudar o Owner de <em>SYSTEM</em> para <em>Administrators</em> - irá abrir uma outra janela pedindo o nome do usuário/grupo que será o novo dono. Dessa forma, seu usuário terá acesso de mudar as demais configurações desse diretório.</p>
<p><img src="img/dbbca645ac430bd964b1e11aebb55ead.png" alt="dbbca645ac430bd964b1e11aebb55ead.png"></p>
<p>Após isso, clique em <em>Replace all child object permission entries with inheritable permission entries from this object</em> e remova TODAS as permissions entries, inclusive dos Administrators. Isso resultará em erro de leitura/escrita pelo serviço do Windows Defender, impedindo seu funcionamento.</p>
<p><img src="img/02517225a6bc731d0bad9c1f8e499365.png" alt="02517225a6bc731d0bad9c1f8e499365.png"></p>
<p>Por fim, execute o <em>msconfig.exe</em> novamente, removendo o <em>Safe Boot</em> e reiniciando a máquina.</p>
<p><img src="img/9b854b4216e7f9299cf82939902f01d8.png" alt="9b854b4216e7f9299cf82939902f01d8.png"></p>
<p>Após reiniciar a máquina, verifique se o Windows Defender está ativo ainda, e caso esteja, siga para a próxima seção.</p>
<h4 id="windows-1011---caso-nenhuma-outra-técnica-funcione">Windows 10/11 - Caso nenhuma outra técnica funcione&hellip;</h4>
<p>Para essa técnica que desenvolvi, torna-se necessário executar o seguinte passo:</p>
<ul>
<li>Desative as seguintes opções no &ldquo;Virus &amp; threat protection&rdquo; - em especial, a Tamper Protection;</li>
</ul>
<p><img src="img/9177be0fc2d905b5c9caba8f9a1b2ac2.png" alt="9177be0fc2d905b5c9caba8f9a1b2ac2.png"></p>
<p>Antes de analisar um malware, execute a seguinte linha em um PowerShell como administrador:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span><span class="vm">$true</span><span class="p">){</span><span class="nb">Set-MpPreference</span> <span class="n">-DisableRealtimeMonitoring</span> <span class="vm">$true</span><span class="p">;</span> <span class="nb">sleep </span><span class="mf">60</span><span class="p">}</span>
</span></span></code></pre></div><p>Essa opção desativará o Windows Defender temporariamente, a cada 60 segundos, enquanto o processo do PowerShell que executar o comando continuar ativo. Ou seja, caso o processo seja encerrado por qualquer motivo, ou o computador reinicie, o Windows Defender será reativado automaticamente. Esse é o principal ponto negativo dessa técnica.</p>
<p>Também é possível adicionar todo o disco <code>C:\</code> na lista de diretórios a não serem varridos pelo Windows Defender - que é uma técnica efetiva para arquivos, mas certas funcionalidades antimalware, como o <a href="https://learn.microsoft.com/pt-br/windows/win32/amsi/antimalware-scan-interface-portal">AMSI</a>, continuarão ativas e detectando e bloqueando comandos maliciosos.</p>
<p>Uma última opção é procurar por scripts, como <a href="https://github.com/ionuttbara/windows-defender-remover">esse</a>, que se propõem a realizar a remoção forçada do Windows Defender. Para isso, é necessário pesquisar e estudar os efeitos colaterais dos scripts, bem como buscar uma versão atualizada - muitos deles não funcionam após algumas releases do Windows.</p>
<h3 id="desativação-do-firewall">Desativação do Firewall</h3>
<p>O firewall padrão do Windows pode ser desativado facilmente através da pesquisa pela palavra <em>firewall</em> no menu pesquisar e clicar em <em>Firewall &amp; network protection</em>.</p>
<p><img src="img/40b637fe2ac65252a622a82342fc9336.png" alt="40b637fe2ac65252a622a82342fc9336.png"></p>
<p>Desative o firewall para todos os tipos de rede que estiverem presentes:</p>
<p><img src="img/128d6be008e414c1903ad0deb9609147.png" alt="128d6be008e414c1903ad0deb9609147.png"></p>
<h3 id="desativação-do-user-account-control">Desativação do User Account Control</h3>
<p>O UAC é uma medida que requisita autorização de um usuário Administrador para ações de alto privilégio no sistema - famoso por aquele prompt de sim/não quando um software quer executar algo como administrador.</p>
<p>Para isso, pesquise por &ldquo;UAC&rdquo; no menu pesquisar do Windows, selecione &ldquo;User Account Control Settings&rdquo; e coloque &ldquo;Never notify&rdquo;. Confirme com OK.</p>
<p><img src="img/c836cd083878eb00e9a7b34eaad63bfc.png" alt="c836cd083878eb00e9a7b34eaad63bfc.png"></p>
<h3 id="desativação-do-windows-update">Desativação do Windows Update</h3>
<p>Para evitar problemas como a restauração do Windows Defender, é interessante desativar o Windows Update. Isso também irá diminuir tentativas de conexão aos serviços Microsoft legítimos na captura de pacotes. Caso o leitor tenha obtido suas ferramentas via <em>retoolkit</em> via instalação padrão, o Windows Update já está desativado.</p>
<h2 id="configuração-da-rede">Configuração da rede</h2>
<p><strong>Muita atenção à essa parte!</strong> A configuração correta da rede é fundamental para a segurança do host e da rede doméstica em que ele está inserido. Em resumo, iremos configurar uma rede interna, sem acesso algum à internet ou ao host. Isso significa que iremos mudar o adaptador de rede do hypervisor para uma rede interna (VirtualBox) ou hostonly <strong>configurada sem adaptador para o host</strong> (VMware).</p>
<p>Siga à risca os passos para as VMs explicitados nas seções que seguem para evitar problemas de segurança.</p>
<h3 id="windows-malware">Windows Malware</h3>
<p>No VirtualBox, selecione a VM Windows, clique em Settings e navegue até a aba &ldquo;Network&rdquo;:</p>
<p><img src="img/e03737c8dc50caa1fce8bdb17b6f65f3.png" alt="e03737c8dc50caa1fce8bdb17b6f65f3.png"></p>
<p>Troque o tipo do adaptador 1 de &ldquo;NAT&rdquo; para &ldquo;Internal Network&rdquo;, e coloque um nome como <em>malware_internal</em> na sua rede. Clique em OK.</p>
<blockquote>
<p>No VirtualBox, quando se nomeia uma rede, ela é criada automaticamente e fica disponível para configuração nas demais VMs.</p>
</blockquote>
<p><img src="img/3a1a26efd65cd6e51ea0889b2228596e.png" alt="3a1a26efd65cd6e51ea0889b2228596e.png"></p>
<p>Execute o painel de controle do Windows e navegue até <em>Network and Internet &gt; Network and Sharing Center &gt; Change adapter settings</em>. Clique com o botão direito no adaptador de Ethernet (deve ser o único que está conectado no ambiente) e clique em propriedades:</p>
<p><img src="img/37bd1418940bf66ba5d96c0db60219dc.png" alt="37bd1418940bf66ba5d96c0db60219dc.png"></p>
<p>Pesquise por <em>Internet Protocol Version 4 (TCP/IPv4)</em> e clique em propriedades:</p>
<p><img src="img/810e5f2e0eff72dd090531efa5398e5e.png" alt="810e5f2e0eff72dd090531efa5398e5e.png"></p>
<p>Coloque as exatas informações que estão na imagem abaixo na janela que abrir. Basicamente estamos definindo o IP do Windows como 172.16.0.2, e todo o tráfego deverá ir para o gateway 172.16.0.1 (REMnux, que iremos configurar abaixo). Clique nos dois OKs após configurar.</p>
<p><img src="img/8d9cad9deb3173b94b088e02404ef533.png" alt="8d9cad9deb3173b94b088e02404ef533.png"></p>
<h3 id="remnux">REMnux</h3>
<p>Na REMnux, altere as configurações do adaptador como feito na Windows. Nesse caso, a rede poderá ser selecionada sem a necessidade da digitação do nome dela novamente no campo <em>Name</em>.</p>
<p><img src="img/3f878c77c912efbdc383cccce38fc712.png" alt="3f878c77c912efbdc383cccce38fc712.png"></p>
<p><img src="img/6d37ba63db61e5bf4e61551a8d76bf7a.png" alt="6d37ba63db61e5bf4e61551a8d76bf7a.png"></p>
<blockquote>
<p>Caso o layout do seu teclado seja o padrão brasileiro (ABNT/ABNT2), execute o comando  <code>setxkbmap br</code> em um terminal para configurar temporariamente o REMnux para utilizar esse padrão.</p>
</blockquote>
<p>Edite o arquivo <em>/etc/netplan/01-netcfg.yaml</em> com um editor de texto (pode utilizar o <em>nano</em> ou o <em>vim</em>, por exemplo). O arquivo deve se parecer com esse abaixo. Lembre-se de editar com privilégios root!</p>
<blockquote>
<p>Por exemplo, <code>sudo nano /etc/netplan/01-netcfg.yaml</code></p>
</blockquote>
<p><img src="img/a7293fc3a1bfaaa39818b3dc7063a663.png" alt="a7293fc3a1bfaaa39818b3dc7063a663.png"></p>
<p>O conteúdo deve ser exatamente o seguinte - com exceção do nome do adaptador, caso ele seja diferente do seu laboratório. Lembre-se de indentar corretamente com 2 espaços ou o YAML poderá não ser lido com sucesso.</p>
<blockquote>
<p>Estamos definindo uma configuração de rede estática para nossa VM REMnux, em que ela terá o IP 172.16.0.1.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">renderer</span><span class="p">:</span><span class="w"> </span><span class="l">networkd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ethernets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enp0s3</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">addresses</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">172.16.0.1</span><span class="l">/24]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">gateway4</span><span class="p">:</span><span class="w"> </span><span class="m">172.16.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nameservers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">addresses</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">172.16.0.1</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>Exemplo da configuração correta do arquivo está na imagem abaixo.</p>
<p><img src="img/71651f326bea807548985022e3d81db4.png" alt="71651f326bea807548985022e3d81db4.png"></p>
<p>Por fim, execute o comando <code>sudo netplan apply</code> para aplicar as configurações.</p>
<h3 id="testando-a-configuração">Testando a configuração</h3>
<p>Após a configuração realizada nas duas VMs, inicie as duas e abra um terminal/cmd nas duas e tente realizar um ping para o IP da outra (REMnux deve realizar o ping para 172.16.0.2 e o Windows para 172.16.0.1). Ele deve ser efetuado com sucesso, ou então há algum problema com sua configuração.</p>
<p><img src="img/a7a1025f652f3c9410bf1c05744be511.png" alt="a7a1025f652f3c9410bf1c05744be511.png"></p>
<h2 id="snapshots">Snapshots</h2>
<p>Após a instalação correta das ferramentas, definição das configurações e rede, seria muito chato rodar um malware nesse ambiente e ter que refazer todo o ambiente novamente, não é mesmo?</p>
<p>Para evitar isso, utilizaremos uma funcionalidade essencial para laboratórios virtuais: <em>Snapshots</em>. Eles servem para salvar a máquina virtual, suas configurações, sua RAM e seu contexto de execução em um dado momento. A partir daí, é possível retornar quando quiser a esse contexto, de maneira rápida e facilitada.</p>
<p>Para a análise de malware, snapshots são interessantes para salvar o estado inicial, limpo, apenas com as ferramentas e configurações feitas, para que o laboratório sempre possa ser restaurado para um estado não infectado facilmente. Além disso, snapshots em pontos diferentes da análise de um malware podem ser úteis para entender melhor o funcionamento de certas partes do código malicioso, sempre podendo retornar a um estado anterior ou próximo.</p>
<p>Nessa seção, vamos fazer o snapshot do estado limpo que criamos para as VMs. É possível fazer o snapshot enquanto a máquina está rodando - e isso conta com vantagens na análise, conforme explicado em <a href="#medidas-adicionais">Medidas adicionais</a> - mas demorará mais tempo para ser criado e mais armazenamento.</p>
<p>Por esses motivos, faremos o snapshot desse primeiro estado com as VMs desligadas. Fica a cargo do leitor decidir se seguirá dessa forma ou com a máquina ativa - não há problemas de segurança quanto a isso.</p>
<p>Para realizar o snapshot, clique em qualquer VM do laboratório e após isso clique no menu &ldquo;hambúrguer&rdquo; que aparecerá ao lado da VM selecionada. Selecione &ldquo;Snapshots&rdquo; para mostrar as informações e controles de snapshots para aquela VM na tela.</p>
<p><img src="img/0041c0292424e58119df73601ea5513f.png" alt="0041c0292424e58119df73601ea5513f.png"></p>
<p>Após isso, clique em &ldquo;Take&rdquo; e nomeie o snapshot com algum nome que faça sentido - como &ldquo;main&rdquo; para o estado limpo, padrão da VM. Clique em OK.</p>
<p><img src="img/11af0a1b1a9ef4ad29dbc4c1773eb26e.png" alt="11af0a1b1a9ef4ad29dbc4c1773eb26e.png"></p>
<p>Após alguns segundos, o snapshot será criado:</p>
<p><img src="img/febc47c9e03c55f585e687a1aa1e6d2f.png" alt="febc47c9e03c55f585e687a1aa1e6d2f.png"></p>
<p>Caso necessite restaurar o snapshot, clique no snapshot criado e em &ldquo;Restore&rdquo;. Faça isso sempre que terminar de analisar um malware ou desejar analisar vários estados de um malware que estão em snapshots diferentes.</p>
<p><img src="img/6aa80aba8e2452e958dd2d56e9ba95a8.png" alt="6aa80aba8e2452e958dd2d56e9ba95a8.png"></p>
<p>Faça o mesmo processo para a outra VM (REMnux ou Windows). Após isso, o laboratório está 100% pronto para receber malwares!</p>
<h1 id="precauções-de-uso-do-laboratório">Precauções de uso do laboratório</h1>
<p>As precauções abaixo devem ser seguidas para evitar infecção descontrolada, escape de malware para o host ou movimentação lateral na rede doméstica.</p>
<ul>
<li>
<p>Não adicione máquinas que não são para fins de análise na mesma rede isolada do laboratório;</p>
</li>
<li>
<p>Elimine todas, ou a maioria, das conexões que existirem das máquinas do laboratórios com seu host, como compartilhamento de arquivos em rede (NFS/SMB);</p>
</li>
<li>
<p>Compartilhamento de diretórios via shared folders no hypervisor deve se dar com extrema cautela, e sempre que possível, em apenas leitura. É preferível que uma máquina limpa do laboratório, não infectada nem explorada, seja utilizada para obter arquivos de uma máquina infectada (como arquivos dropados), e após isso passar dessa máquina limpa para o host;</p>
</li>
<li>
<p>Caso acesso a outras máquinas do laboratório ou à Internet não seja necessário, desative o adaptador de rede virtual no hypervisor;</p>
</li>
<li>
<p>O acesso à Internet deve ser extremamente restrito, e deve ser utilizado a rede Tor ou VPN com killswitch sempre que necessário comunicar-se externamente;</p>
</li>
<li>
<p>Não utilize o laboratório para outros propósitos além de analisar malware. <strong>Não coloque arquivos sensíveis no laboratório, ainda mais com acesso a Internet!</strong></p>
</li>
<li>
<p>Sempre atualize o hypervisor para evitar que vulnerabilidades de escape para o host sejam exploradas;</p>
</li>
</ul>
<h1 id="medidas-adicionais">Medidas adicionais</h1>
<p>Para um laboratório eficiente, é interessante que o ambiente seja moldado para parecer o mínimo possível com um laboratório. Para esse objetivo:</p>
<ul>
<li>
<p>Instale softwares comuns: pacote Office, browsers etc;</p>
</li>
<li>
<p>Navegue um pouco na internet, salve algumas senhas falsas no browser</p>
</li>
<li>
<p>Deixe a VM aberta um tempo e salve um snapshot live, para contabilizar tempo de uptime;</p>
</li>
<li>
<p>Instale softwares vulneráveis, como o pacote Office sem correção para a vulnerabilidade <em>Follina</em>, para identificar mais facilmente a tentativa de exploração de vulnerabilidades;</p>
</li>
<li>
<p>Crie/baixe arquivos comuns - notas, PDFs, imagens - não sensíveis/críticas;</p>
</li>
<li>
<p>Remova quaisquer indícios de virtualização: dispositivos, drivers, arquivos específicos, etc. A VM também deve ter mais de um processador pois alguns malwares identificam laboratórios de análise pela quantidade de núcleos de processamento;</p>
</li>
<li>
<p>Se possível, altere as localizações padrão de instalação dos softwares de análise.</p>
</li>
</ul>
<p>Seu ambiente pode ser testado para demais técnicas utilizadas por malwares em variados contextos (Debugging, Sandbox etc) através do seguinte projeto:</p>
<ul>
<li><a href="https://github.com/ayoubfaouzi/al-khaser">https://github.com/ayoubfaouzi/al-khaser</a></li>
</ul>
<h1 id="conclusão">Conclusão</h1>
<p>Nesse ponto, caso o leitor tenha seguido o passo-a-passo completo, ele terá consigo um laboratório simples e reiniciável e apto a realizar análises de artefatos suspeitos e malwares, com possibilidade de simulação de serviços e captura de pacotes de rede de forma confiável.</p>

    
    <div class="nav-next-prev">
        <div class="nav-prev">
            
                <a href="https://blog.midnighthackings.com/posts/malware-analysis-0x00/"><i class="fas fa-chevron-left"></i></a>
            
        </div>
        <a class="nav-top" href="#">top</i></a>
        <div class="nav-next">
            
                <a class="grayed-out" href="javascript:void()"><i class="fas fa-chevron-right"></i></a>
            
        </div>
    </div>
    

            </div><footer>
<div class="footer-content">

  <div class="contact-info">
      
          <div class="footer-mail">
          <i class="far fa-envelope"></i> <a href="mailto:midnight.reverser@outlook.com">midnight.reverser@outlook.com</a> </div>
      
      
  </div>


<img src="https://www.gnu.org/graphics/gplv3-with-text-136x68.png"/>
&nbsp;&nbsp;
<p class="copyright meta"> Midnight Hackings apoia GPL e o fim da escala 6x1!</p>

</div>
</footer></main>
    </body>
    <script src=https://blog.midnighthackings.com/js/navbutton.js></script>
</html>
